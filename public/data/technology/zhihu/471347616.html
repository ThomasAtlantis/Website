<h2>安装并配置MongoDB</h2><p data-pid="PqwVNosM">最近做爬虫时苦于SQL关系表设计的繁文缛节，发现NoSQL天然支持JSON格式的存储，于是打算动手尝试一下。由于比较心疼笔记本电脑的SSD，打算把服务部署在服务器上，使用远程连接的方式存储内容。这里我使用的是NoSQL中比较有代表性的MongoDB，服务器系统为Ubuntu 18.04.6 LTS，本机为MacOS。如果不确定自己的linux系统是什么版本，可以使用如下命令查看：</p><div class="highlight"><pre><code class="language-bash"><span></span>lsb_release -a
----------------------------------
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu <span class="m">18</span>.04.6 LTS
Release:	<span class="m">18</span>.04
Codename:	bionic
</code></pre></div><p data-pid="JYC8J9Hv">被安装环境的事虐过无数次之后，经验表明，当你在linux下安装一个软件，能用apt安装就尽量不要手动安装，除非你很了解linux系统中各部分运行的原理。建议使用以下命令安装MongoDB：</p><div class="highlight"><pre><code class="language-bash"><span></span>apt-get install mongodb
</code></pre></div><p data-pid="4gJxu8sJ">如果你已经被网上某些陈旧的教程骗了，选择了手动安装，那么可能会遇到一些坑，我在这里记录一下。首先你会在<a href="http://link.zhihu.com/?target=https%3A//www.mongodb.com/try/download/community" class=" wrap external" target="_blank" rel="nofollow noreferrer">官网</a>下载二进制文件的tgz压缩包：</p><figure data-size="normal"><noscript><img src="https://pica.zhimg.com/v2-0c50382a41ce7986de5ca2116260484d_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="1920" data-rawheight="944" class="origin_image zh-lightbox-thumb" width="1920" data-original="https://picx.zhimg.com/v2-0c50382a41ce7986de5ca2116260484d_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1920'%20height='944'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1920" data-rawheight="944" class="origin_image zh-lightbox-thumb lazy" width="1920" data-original="https://picx.zhimg.com/v2-0c50382a41ce7986de5ca2116260484d_720w.jpg?source=d16d100b" data-actualsrc="https://pica.zhimg.com/v2-0c50382a41ce7986de5ca2116260484d_720w.jpg?source=d16d100b"></figure><p data-pid="_k0HM-0o">然后解压并移动：</p><div class="highlight"><pre><code class="language-bash"><span></span>tar -zxf mongodb-linux-x86_64-ubuntu1804-5.0.6.tgz
mv mongodb-linux-x86_64-ubuntu1804-5.0.6 /usr/local/mongodb5
</code></pre></div><p data-pid="fmirEt7v">将移动后位置的bin目录加入到环境变量PATH中：</p><div class="highlight"><pre><code class="language-bash"><span></span>vim ~/.bashrc
<span class="o">=========================================</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/usr/local/mongodb5/bin:<span class="nv">$PATH</span>

<span class="nb">source</span> ~/.bashrc
</code></pre></div><p data-pid="5ihOp3Qg">可以编辑一个配置文件：</p><div class="highlight"><pre><code class="language-bash"><span></span>vim /usr/local/mongodb5/mongodb.conf
<span class="o">====================================</span>
<span class="nv">dbpath</span><span class="o">=</span>/var/lib/mongo
<span class="nv">logpath</span><span class="o">=</span>/var/log/mongodb/mongod.log
<span class="nv">logappend</span><span class="o">=</span><span class="nb">true</span>
<span class="nv">bind_ip</span><span class="o">=</span><span class="m">0</span>.0.0.0
<span class="nv">port</span><span class="o">=</span><span class="m">27017</span>
<span class="nv">fork</span><span class="o">=</span><span class="nb">true</span>
<span class="nv">journal</span><span class="o">=</span><span class="nb">true</span>
<span class="c1"># auth=true</span>
</code></pre></div><p data-pid="Dmk_nAJN">这里dbpath是数据库的存储位置，logpath是日志文件的生成位置，如果这两个文件夹不存在，可以先mkdir -p创建它们，你也可以指定到自己喜欢的位置。然后就可以启动MongoDB服务器了：</p><div class="highlight"><pre><code class="language-bash"><span></span>/usr/local/mongodb5/bin/mongod --config /usr/local/mongodb5/mongodb.conf
</code></pre></div><p data-pid="_CLe-z4Y">使用mongo命令进入到MongoDB的shell中，我们在里面新建一个管理员账号：</p><div class="highlight"><pre><code class="language-js"><span></span><span class="o">&gt;</span> <span class="nx">use</span> <span class="nx">admin</span>
<span class="nx">switched</span> <span class="nx">to</span> <span class="nx">db</span> <span class="nx">admin</span>
<span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">createUser</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span> <span class="s2">"root"</span><span class="p">,</span> <span class="nx">pwd</span><span class="o">:</span> <span class="s2">"zgu;-spffoAN1e/7p~h["</span><span class="p">,</span> <span class="nx">roles</span><span class="o">:</span> <span class="p">[{</span><span class="nx">role</span><span class="o">:</span> <span class="s2">"root"</span><span class="p">,</span> <span class="nx">db</span><span class="o">:</span> <span class="s2">"admin"</span><span class="p">}]})</span>
<span class="nx">Successfully</span> <span class="nx">added</span> <span class="nx">user</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"user"</span> <span class="o">:</span> <span class="s2">"root"</span><span class="p">,</span>
    <span class="s2">"roles"</span> <span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">"role"</span> <span class="o">:</span> <span class="s2">"root"</span><span class="p">,</span>
            <span class="s2">"db"</span> <span class="o">:</span> <span class="s2">"admin"</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div><p data-pid="HzE4Pz5t">然后停止服务器，可以在shell中这样：</p><div class="highlight"><pre><code class="language-js"><span></span><span class="o">&gt;</span> <span class="nx">use</span> <span class="nx">admin</span>
<span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">shutdownServer</span><span class="p">()</span>
</code></pre></div><p data-pid="Ct7lX2Y4">也可以exit退出shell后使用和启动对应的命令：</p><div class="highlight"><pre><code class="language-bash"><span></span>/usr/local/mongodb5/bin/mongod --config /usr/local/mongodb5/mongodb.conf --shutdown
</code></pre></div><p data-pid="7LXn8xEm">然后我们修改配置文件，将里面的auth设为true，这样远程访问时就需要登录认证才可以获得权限：</p><div class="highlight"><pre><code class="language-bash"><span></span>vim /usr/local/mongodb5/mongodb.conf
<span class="o">====================================</span>
<span class="nv">auth</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div><h2>注册MongoDB为系统服务</h2><p data-pid="b-cxVBTA">接下来重点来了，每次手动启动和shutdown很麻烦，怎样将其注册为系统服务呢？这里举几个错误示例：</p><ol><li data-pid="lfLc-bV5"><a href="http://link.zhihu.com/?target=https%3A//www.jianshu.com/p/9882745767fd" class=" wrap external" target="_blank" rel="nofollow noreferrer">Linux下安装、配置mongodb，并注册成后台启动的服务的一次经历</a>：修改/etc/init.d/下的配置文件，你会发现Ubuntu18.04中没有chkconfig命令；</li><li data-pid="hJD4vTya"><a href="http://link.zhihu.com/?target=http%3A//t.zoukankan.com/shikyoh-p-10683589.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">linux mongodb开机启动(服务的方式)</a>：修改/lib/systemd/system下的service配置文件，你会发现会报Can‘t open PID file的错误；</li></ol><p data-pid="JGZGvoqi">正确的做法是按照第二点中进行配置，但要修改PIDFile参数，下面讲一下步骤。首先编辑配置文件：</p><div class="highlight"><pre><code class="language-bash"><span></span>vim /lib/systemd/system/mongodb.service
<span class="o">================================================================================================</span>
<span class="o">[</span>Unit<span class="o">]</span>  
    <span class="nv">Description</span><span class="o">=</span>mongodb  
    <span class="nv">After</span><span class="o">=</span>network.target remote-fs.target nss-lookup.target  
  
<span class="o">[</span>Service<span class="o">]</span>   
    <span class="nv">Type</span><span class="o">=</span>forking
    <span class="nv">RuntimeDirectory</span><span class="o">=</span>mongodb
    <span class="nv">RuntimeDirectoryMode</span><span class="o">=</span><span class="m">0751</span>
    <span class="nv">PIDFile</span><span class="o">=</span>/var/run/mongodb/mongod.pid
    <span class="nv">ExecStart</span><span class="o">=</span>/usr/local/mongodb5/bin/mongod --config /usr/local/mongodb5/mongodb.conf
    <span class="nv">ExecStop</span><span class="o">=</span>/usr/local/mongodb5/bin/mongod --shutdown --config /usr/local/mongodb5/mongodb.conf
    <span class="nv">PrivateTmp</span><span class="o">=</span><span class="nb">false</span>
  
<span class="o">[</span>Install<span class="o">]</span>  
    <span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div><p data-pid="O72gL4FA">这里ExecStart中可执行文件和配置文件的位置需要自己指定，如果你是按照上文进行安装就不需要更改。</p><p data-pid="jBN_I3jU">这里问题就出在PIDFile不存在。大概什么意思呢？MongoDB在启动时如果指定参数--fork或者在配置文件中有fork=true，那么就会在后台运行服务，这时候服务进程是被fork出来的子进程，fork结束后parent进程会自动退出。那么系统想要知道服务是否在运行，就需要记录这个子进程PID的文件。我们刚刚指定了数据库存储的位置为/var/lib/mongo，而MongoDB在启动后会将PID存储在lock文件中，所以我们只需要修改上面配置文件的PIDFIle为如下：</p><div class="highlight"><pre><code class="language-bash"><span></span><span class="nv">PIDFile</span><span class="o">=</span>/var/lib/mongo/mongod.lock
</code></pre></div><p data-pid="yQcalImN">修改service文件后需要重启守护进程：</p><div class="highlight"><pre><code class="language-text"><span></span>systemctl daemon-reload
</code></pre></div><p data-pid="LRBV1yqo">然后我们启动服务：</p><div class="highlight"><pre><code class="language-bash"><span></span>systemctl start mongodb.service
</code></pre></div><p data-pid="Sh7M3vEb">可以查看服务状态：</p><div class="highlight"><pre><code class="language-bash"><span></span>systemctl status mongodb.service
<span class="o">=========================================================================================================================================</span>
● mongodb.service - mongodb
   Loaded: loaded <span class="o">(</span>/lib/systemd/system/mongodb.service<span class="p">;</span> disabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
   Active: active <span class="o">(</span>running<span class="o">)</span> since Wed <span class="m">2022</span>-02-23 <span class="m">15</span>:27:55 CST<span class="p">;</span> 57min ago
  Process: <span class="m">2915</span> <span class="nv">ExecStop</span><span class="o">=</span>/usr/local/mongodb5/bin/mongod --shutdown --config /usr/local/mongodb5/mongodb.conf <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span><span class="m">0</span>/SUCCE
  Process: <span class="m">2919</span> <span class="nv">ExecStart</span><span class="o">=</span>/usr/local/mongodb5/bin/mongod --config /usr/local/mongodb5/mongodb.conf <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span><span class="m">0</span>/SUCCESS<span class="o">)</span>
 Main PID: <span class="m">2921</span> <span class="o">(</span>mongod<span class="o">)</span>
    Tasks: <span class="m">34</span> <span class="o">(</span>limit: <span class="m">4508</span><span class="o">)</span>
   CGroup: /system.slice/mongodb.service
           └─2921 /usr/local/mongodb5/bin/mongod --config /usr/local/mongodb5/mongodb.conf
</code></pre></div><p data-pid="gs7CJ-G9">看到Active: active (running)说明服务启动成功。</p><h2>远程连接MongoDB数据库</h2><p data-pid="hZcnCm1O">在MBP上下载对应版本的tgz文件，和上面流程一样。下载后解压，然后进入到bin目录，使用以下命令连接服务器：</p><div class="highlight"><pre><code class="language-bash"><span></span>./mongo XX.XX.XX.XX:27017/ -u <span class="s2">"root"</span> -p <span class="s2">"zgu;-spffoAN1e/7p~h["</span>
</code></pre></div><p data-pid="bCIk2voD">其中XX.XX.XX.XX是服务器对应的IP地址，如果不知道IP，可以在服务器上：</p><div class="highlight"><pre><code class="language-bash"><span></span>curl ifconfig.me
</code></pre></div><p data-pid="OG6i-RHU">当然除了这种认证方式，也可以省去参数直接连接，然后使用auth函数进行认证：</p><div class="highlight"><pre><code class="language-bash"><span></span>./mongo XX.XX.XX.XX:27017/ 
&gt; use admin
&gt; db.auth<span class="o">(</span><span class="s2">"root"</span>, <span class="s2">"zgu;-spffoAN1e/7p~h["</span><span class="o">)</span>
</code></pre></div><p data-pid="QQs-BH8z">然后就可以快乐地使用数据库啦，使用方式可以参考官方文档：<a href="http://link.zhihu.com/?target=https%3A//docs.mongodb.com/manual/tutorial/getting-started/" class=" wrap external" target="_blank" rel="nofollow noreferrer">MongoDB | Getting Started</a></p>