<h2>一则小故事</h2><p data-pid="M-YFPpcB">子晗是市一中高三八班的信息竞赛生，在学校对面的小区租房走读。一天深夜，她看了电影《社交网络》后十分兴奋，心想自己也可以效法扎克伯格搞个 Facemash，只可惜没数据。</p><p data-pid="7ti_P1xf">她望向窗外，看到对街校门口人脸识别闸机闪着红光，旋即奇思妙想，连夜顺着闸机上行网线找到绿化带里的路由器机箱，爆破后植入了流量劫持木马。</p><p data-pid="M7hwfUH7">三天后，她又用信号增强手段伪造校园网 WiFi 网关，给全校同学“推荐”了自制的 App。同学们一看，每天推送小姐姐素颜照片，问我喜不喜欢，还是阅后即焚，非常兴奋。纷纷赞叹这个模式好：“只给我1秒钟反应时间，准确捕捉第一印象；最不经意的抓拍，也没有修图，十分真实。”</p><p data-pid="LiONBHZx">不过子晗始终没有公开评分的结果，嫉妒心强的女生们纷纷开始谎称自己被 App 评为了班花，毕竟也不能证伪。校园里乌烟瘴气，学校后知后觉发现了这件事，但一时间调查不出始作俑者。</p><p data-pid="nAUlobtS">最后园丁大妈说绿化带里的机箱合不上盖子，怕被雨淋了，领导才意识到闸机被黑了，于是调监控查到了子晗头上，请她喝茶。</p><p data-pid="sgGDUq6I">一个领导想大事化小，欣赏子晗的才华，说这些评分数据有意义，我们学校可以基于此搞自己的新媒体矩阵。另一个领导不太客气，主要是自己的闺女也在学校读书，害怕这种比较让学生产生容貌焦虑，主要是自己的闺女也不好看。</p><p data-pid="1l2svAkE">两个人在会议上差点打起来。争吵之间，不知道是谁对子晗说了句难听的“好看有什么用，我看看你多少分？”子晗也没理解对，人家问的是考分，她以为是颜值分，自尊心碎了，心想那就毁灭吧，掏出笔记本电脑，开始了她的表演：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></div><p data-pid="cwjyS9RI">“比方说，这是现在的评分，3 个年级，10 个班，每班 50 号人，评分区间是 1 到 10。”领导安静下来，不知道子晗要搞什么名堂。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">winner_scores</span><span class="p">,</span> <span class="n">winner_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div><p data-pid="DyT50krZ">“比方说，这是现在各班‘班花’的评分和学号。自然，‘班花’是在班级这个维度比较。”领导显然没觉察到子晗话里的引号。</p><div class="highlight"><pre><code class="language-text"><span></span>message_box = torch.zeros_like(scores)
</code></pre></div><p data-pid="E535NEUM">“这是各班的信箱，就各班门前，50个信箱，按学号排的。一开始大家都没有收到消息</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">message_box</span><span class="o">.</span><span class="n">scatter_</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">winner_ids</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">src</span><span class="o">=</span><span class="n">winner_scores</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div><p data-pid="cxGvf7Nn">“评分和学号一一对应。我沿着班级这个维度在所有信箱里找到学号对应的信箱，然后把评分发出去。”子晗说完，领导愣了。你这一个操作就分发下去了？子晗确认的说，就一个操作。</p><p data-pid="LTwjUkCV">领导问她，你这不是比方说吗？子晗轻描淡写地说，不用比方，刚才趁你们吵架已经分发下去了。</p><p data-pid="zIKozZfQ">然而，事情比他们想象得更严重，收到评分的‘班花’是评分最低的。第二天校心理咨询室爆满，唱白脸的领导忙着安慰自己的闺女。子晗被那个唱红脸的领导带到家里访谈。</p><p data-pid="8Ab_KjmW">“子晗妈，您孩子这情况不转学是不成了，”领导说，“但我最后只想问一个问题。”</p><p data-pid="edw7bToI">“我太孤独了，”子晗打断领导，“学校里大家都欺负我，羞辱我长得不好看，可是领导们视而不见。我不是个坚强的人，但我觉得所有的暴力都要还以暴力。”她夺眶而出的眼泪撤回了夺眶，小嘴巴开始吟唱：“起初，没有人在意这一场灾难，这不过是一场山火、一次旱灾、一个物种的灭绝、一座城市的消失，直到这场灾难和每个人息息相关。”</p><p data-pid="pF_RhFSx">子晗妈妈铁青着脸：“可那些同学是无辜的呀！”</p><p data-pid="65NH2E0H">领导说：“你们等会，我不是想问这篇小说的作者编出了个什么动机，又是怎么丧心病狂想到这么写文章，我只好奇，你那天最后一行代码，winner_ids 和 winner_scores 为啥要 unsqueeze一下呀！”</p><h2>关于张量的想象</h2><p data-pid="CR2rPOf9">要搞懂 scatter（或其逆过程 gather）这种张量操作，首先要对张量的形态形成概念。</p><p data-pid="to9lSnXE">通过下标索引高维张量中某元素的过程可记为 x[a_0][a_1][...][a_n]。我们定义 a_0 所在维度为最高维，a_n 为最低维。常见的张量/数组计算框架，如 torch 和 numpy，会将维度从左向右依次编号为 0 到 n，同时用负索引，从右向左依次编号为 -1 到 -n。负索引往往比正索引更常用，因为我们在实际运算中，例如矩阵乘法，通常操作的是最低维，在不知道总共有多少维时使用负索引就十分方便。</p><p data-pid="kgrgbQ_I">我们想象在笔记本上写下一长串元素，模拟一维张量折叠成高维张量的过程：元素先是沿着 -1 维横向铺开，遇到纸张宽度边界后开始沿 -2 维纵向逐行展开，遇到纸张长度边界之后，我们翻过一页，开始在下一页开始书写，这个翻页的动作就是在遍历 -3 维。同理，-4 维可以理解为换不同的笔记本。对应的，在上述子晗的故事里，学号是 -1 维，班级是 -2 维，年级是 -3 维。</p><h2>scatter 究竟在做什么</h2><p data-pid="VoDChp0K">scatter 就是把一个张量里的某些元素分发到另一个容器里。具体分发到什么位置？我们可以创建一个左上角和原张量对齐的索引表。如果索引表和原向量相同形状，那么刚好为每个元素对应指定一个去处；如果索引表比较小，那表的边界以外的那部分元素就不参与分发；索引表不能比原张量更大。</p><p data-pid="2Hmam51U">每个元素的索引毕竟是一个标量，只能指定去处的其中一个维度，于是，我们让元素在索引维度以外的维度上，在容器中所处的位置不变。这就好比班内换座，年级、班级不变，索引就是 -1 维座位号；从高一升高二，年级变了，班级、座位都不变，索引就是 -3 维年级。</p><p data-pid="iaECRXoe">既然索引维度以外的维度上元素的位置不变，那这个容器就至少得“盛得下”这些元素，即这些维度上尺寸不能比原张量小。比如升年级，可以给教室扩容，但得保证学生们按照原来的座次，仍然能坐得下。而在索引维度上，只要索引值不越界，容器多大都行。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-0c46434adabf6021690d9d8d9df0ca2a_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="1480" data-rawheight="762" class="origin_image zh-lightbox-thumb" width="1480" data-original="https://pica.zhimg.com/v2-0c46434adabf6021690d9d8d9df0ca2a_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1480'%20height='762'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1480" data-rawheight="762" class="origin_image zh-lightbox-thumb lazy" width="1480" data-original="https://pica.zhimg.com/v2-0c46434adabf6021690d9d8d9df0ca2a_720w.jpg?source=d16d100b" data-actualsrc="https://pic1.zhimg.com/v2-0c46434adabf6021690d9d8d9df0ca2a_720w.jpg?source=d16d100b"></figure><p data-pid="GJvcur-6">上图是我以三维张量为例说明 scatter 在选择不同维度时元素的分发情况。总结一下，没有哪两个张量要求形状是完全相同的，但索引不能比原张量大，容器不能比原张量小。所有的张量都要具有相同的维数。</p><p data-pid="UozmcV41">子晗的领导大概可以明白了，为什么最后要 unsqueeze 一下：如果不 unsqueeze，winner_ids 和 winner_scores 的形状都是 (3, 10)，这时指定最后一维分发时，指定的是班级这个维度，那么索引里的学号就会越界，因为没有那么多的班。unsqueeze 之后，形状变为 (3, 10, 1)，就可以方便地指定年级和班级不变，只把评分分发到指定学号的学生手里。</p><p data-pid="PwefWl01">实际上，这份代码相当常用，torch 考虑到这个问题，可以用 keep_dim=True 来保持 min 之后的维度数不变：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">winner_score</span><span class="p">,</span> <span class="n">winner_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">message_box</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
<span class="n">message_box</span><span class="o">.</span><span class="n">scatter_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">winner_id</span><span class="p">,</span> <span class="n">winner_score</span><span class="p">)</span>
</code></pre></div><p data-pid="MB74PQtq">将 min 换成 max，scores 换成概率分布，这段代码实际上是在取 3 个样本在早退神经网络的 10 个分支模型中的 50 分类输出概率分布上的最大值（置信度），并把它们放回到对应类别上。这样在样本维度上一平均，我就知道不同分支“擅长”的样本类别的分布了。</p>