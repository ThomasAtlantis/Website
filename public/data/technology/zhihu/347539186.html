<h2>1 问题背景</h2><p data-pid="QFlgAKQC">我在研究依田纪基评注的古谱时发现，除了少数的讲解图和变化图单独罗列，总谱还是以二三百手印在一页居多。<b>想要在二三百手中寻找一步棋，尤其是反复脱先的棋，谈何容易</b>。不仅将花费大量精力，而且会降低思考的连贯性。于是想到，<b>如果有一个扫描棋谱的工具，手机拍照然后就能得到行棋的顺序，或者转成打谱工具所需的通用格式该多好？</b>经过一番调研，没有发现相关研究，于是打算自力更生。</p><p data-pid="KQAGlqGo">当然也许是调研不充分有所遗漏，希望大家不吝赐教。有些人可能认为现在大家都用围棋宝典之类的APP打谱，用野狐围棋之类的平台直接复盘，哪还有人用纸质棋谱啊。我却认为未被电子收录的棋谱反而占多数，家里多数围棋书都是03年以前的，甚至很多80年代的书，总有一些未被收录。况且面对一个纸质谱，在棋谱库里搜索也未必容易。从那个没有手机的年代走过来，还是对纸质谱、实体棋盘有执念，拿着棋子是认真下棋，拿着手机总感觉像在娱乐。</p><h2>2 实验过程</h2><h3><b>2.1 获取数据：文档扫描模式及滤镜增强</b></h3><p data-pid="ei_hSyrH">一开始尝试使用原相机以比较歪的角度拍照，但实验效果不佳。我从未从事过图像处理领域，所以对图像自动矫正也不了解。这里为了提升效果、节约周期，我<b>使用Mi10 Pro的后置摄像头的文档模式进行拍照，之后手动矫正</b>。</p><figure data-size="normal"><noscript><img src="https://picx.zhimg.com/v2-4c9309c74eabbae39ccb1e0fc46bdcf2_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="2340" data-rawheight="1080" class="origin_image zh-lightbox-thumb" width="2340" data-original="https://pic1.zhimg.com/v2-4c9309c74eabbae39ccb1e0fc46bdcf2_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='2340'%20height='1080'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="2340" data-rawheight="1080" class="origin_image zh-lightbox-thumb lazy" width="2340" data-original="https://pic1.zhimg.com/v2-4c9309c74eabbae39ccb1e0fc46bdcf2_720w.jpg?source=d16d100b" data-actualsrc="https://picx.zhimg.com/v2-4c9309c74eabbae39ccb1e0fc46bdcf2_720w.jpg?source=d16d100b"></figure><p data-pid="slQlUnbv">注意选择四个顶点时使得边框与棋盘边缘大致平行。然后选择增强滤镜以提升照片的对比度。这款小米手机的近距离对焦做得非常差，如果使用其他手机，实验效果很可能提升。当然如果使用PDF文档截图或者专业扫描仪进行扫描，准确率会大幅提升。</p><figure data-size="normal"><noscript><img src="https://picx.zhimg.com/v2-1254b098d3c5a8058349ba2b58e00b1c_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="1138" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-1254b098d3c5a8058349ba2b58e00b1c_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1080'%20height='1138'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="1138" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic1.zhimg.com/v2-1254b098d3c5a8058349ba2b58e00b1c_720w.jpg?source=d16d100b" data-actualsrc="https://picx.zhimg.com/v2-1254b098d3c5a8058349ba2b58e00b1c_720w.jpg?source=d16d100b"></figure><h3><b>2.2 棋子检测：边缘检测及霍夫圆变换</b></h3><p data-pid="ERiQmwyR"><b>霍夫圆变换</b>  接下来我们对棋子进行识别。棋子就是规律的圆形，我们可以使用霍夫圆变换的方法检测圆形。霍夫法的本质是一种坐标变换，将原始的二维位置坐标变换到新的坐标系下，后者的维数由待检测图形方程的未知数数量决定。例如检测直线，过已知点的直线有两个参数 <img src="https://www.zhihu.com/equation?tex=k" alt="k" eeimg="1"> 和 <img src="https://www.zhihu.com/equation?tex=b" alt="b" eeimg="1"> ：</p><p data-pid="2vQnND6U"><img src="https://www.zhihu.com/equation?tex=y%3Dkx%2Bb%5C%5C" alt="y=kx+b\\" eeimg="1"> </p><p data-pid="EWNjJpT7">这也对应了两点确定一条直线，因为两个方程联立恰好能解二元一次方程。那么这时就是将坐标系<img src="https://www.zhihu.com/equation?tex=%28x%2C+y%29" alt="(x, y)" eeimg="1"> 变换为坐标系 <img src="https://www.zhihu.com/equation?tex=%28k%2C+b%29" alt="(k, b)" eeimg="1"> 。原来图像上的两点，就变为新坐标系下的两条直线：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-c557485aa0b74b6e7b85bc96d9c6ff86_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="2560" data-rawheight="684" class="origin_image zh-lightbox-thumb" width="2560" data-original="https://picx.zhimg.com/v2-c557485aa0b74b6e7b85bc96d9c6ff86_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='2560'%20height='684'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="2560" data-rawheight="684" class="origin_image zh-lightbox-thumb lazy" width="2560" data-original="https://picx.zhimg.com/v2-c557485aa0b74b6e7b85bc96d9c6ff86_720w.jpg?source=d16d100b" data-actualsrc="https://pic1.zhimg.com/v2-c557485aa0b74b6e7b85bc96d9c6ff86_720w.jpg?source=d16d100b"></figure><p data-pid="dAaL--Ke">这里两个点的坐标是0到1上均匀分布的随机数，两条直线的表达式如下</p><p data-pid="l-DO01iE"><img src="https://www.zhihu.com/equation?tex=%5Cleft%5C%7B+++%5Cbegin%7Barray%7D%7B%2A%2Arcl%2A%2A%7D+b+%3D+-kx_1%2By_1%5C%5C+b+%3D+-kx_2%2By_2+++++%5Cend%7Barray%7D+%5Cright.++%5C%5C" alt="\left\{   \begin{array}{**rcl**} b = -kx_1+y_1\\ b = -kx_2+y_2     \end{array} \right.  \\" eeimg="1"> </p><p data-pid="aVIjgmfW">这两条直线相交的交点处就相当于两条方程联立，便能解出k和b的值，那么也恰好是原图像上过两个点的直线的参数。也就是说在霍夫变换后的坐标系中，越多的直线相交于一点，就说明原图像中越多的点共线，且系数统一为交点解出的系数。</p><p data-pid="s3QpO5ri">我们发现当 <img src="https://www.zhihu.com/equation?tex=x_1" alt="x_1" eeimg="1"> 和 <img src="https://www.zhihu.com/equation?tex=x_2" alt="x_2" eeimg="1"> 相等时，新坐标系下两直线平行，这违背了两点必共线的原则，为了避免这种特殊情况，霍夫变换实际上使用的是极坐标系。我们把原始图像坐标系变为极坐标系，得到极坐标系下的直线方程，这里约定theta的范围是 <img src="https://www.zhihu.com/equation?tex=%5B0%2C%5Cpi%29" alt="[0,\pi)" eeimg="1"> </p><p data-pid="5i-60ItD"><img src="https://www.zhihu.com/equation?tex=%5Cleft%5C%7B+++%5Cbegin%7Barray%7D%7B%2A%2Arcl%2A%2A%7D+%26y%3D%5Crho+%5Csin+%5Ctheta%5C%5C+%26x%3D+%5Crho+%5Ccos+%5Ctheta+++++%5Cend%7Barray%7D+%5Cright.++%5CLeftrightarrow+%5Cleft%5C%7B+++%5Cbegin%7Barray%7D%7B%2A%2Arcl%2A%2A%7D+%26y%5Csin+%5Ctheta%3D%5Crho+%5Csin+%5E2%5Ctheta%5C%5C+%26x%5Ccos+%5Ctheta+%3D+%5Crho+%5Ccos%5E2+%5Ctheta+++++%5Cend%7Barray%7D+%5Cright.+%5CRightarrow+x%5Ccos+%5Ctheta%2By%5Csin%5Ctheta%3D%5Crho+%5C%5C" alt="\left\{   \begin{array}{**rcl**} &amp;y=\rho \sin \theta\\ &amp;x= \rho \cos \theta     \end{array} \right.  \Leftrightarrow \left\{   \begin{array}{**rcl**} &amp;y\sin \theta=\rho \sin ^2\theta\\ &amp;x\cos \theta = \rho \cos^2 \theta     \end{array} \right. \Rightarrow x\cos \theta+y\sin\theta=\rho \\" eeimg="1"> </p><p data-pid="kZkpokK2">我们可以看到极坐标的优越性，即使 <img src="https://www.zhihu.com/equation?tex=x_1" alt="x_1" eeimg="1"> 和 <img src="https://www.zhihu.com/equation?tex=x_2" alt="x_2" eeimg="1"> 相等，也不会导致联立的方程无解或者多解。这是由于原本在 <img src="https://www.zhihu.com/equation?tex=x" alt="x" eeimg="1"> 上的斜率 <img src="https://www.zhihu.com/equation?tex=k" alt="k" eeimg="1"> 被拆分到 <img src="https://www.zhihu.com/equation?tex=x" alt="x" eeimg="1"> 和 <img src="https://www.zhihu.com/equation?tex=y" alt="y" eeimg="1"> 上，有点参数方程的意思。</p><p data-pid="JUk2sYHa"><img src="https://www.zhihu.com/equation?tex=%5Cleft%5C%7B+++%5Cbegin%7Barray%7D%7B%2A%2Arcl%2A%2A%7D+x_1%5Ccos+%5Ctheta%2By_1%5Csin%5Ctheta%3D%5Crho%5C%5C+x_1%5Ccos+%5Ctheta%2By_1%5Csin%5Ctheta%3D%5Crho+++++%5Cend%7Barray%7D+%5Cright.++%5CRightarrow+%28x_1-x_2%29%5Ccos%5Ctheta%2B%28y_1-y_2%29%5Csin%5Ctheta%3D0+%5C%5C" alt="\left\{   \begin{array}{**rcl**} x_1\cos \theta+y_1\sin\theta=\rho\\ x_1\cos \theta+y_1\sin\theta=\rho     \end{array} \right.  \Rightarrow (x_1-x_2)\cos\theta+(y_1-y_2)\sin\theta=0 \\" eeimg="1"> </p><p data-pid="WbzhIyrN">极坐标系下霍夫变换后的图像如下。同样，多条曲线相交处确定原图的一条直线。</p><figure data-size="normal"><noscript><img src="https://picx.zhimg.com/v2-308a3a3656d725189df92edf6e1dd63d_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="2560" data-rawheight="668" class="origin_image zh-lightbox-thumb" width="2560" data-original="https://picx.zhimg.com/v2-308a3a3656d725189df92edf6e1dd63d_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='2560'%20height='668'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="2560" data-rawheight="668" class="origin_image zh-lightbox-thumb lazy" width="2560" data-original="https://picx.zhimg.com/v2-308a3a3656d725189df92edf6e1dd63d_720w.jpg?source=d16d100b" data-actualsrc="https://picx.zhimg.com/v2-308a3a3656d725189df92edf6e1dd63d_720w.jpg?source=d16d100b"></figure><p data-pid="MiLrmvkN">那么圆的霍夫变换和直线类似。我们知道三点确定一个圆，所以圆的方程必然包含三个未知参量，霍夫空间为三维空间。原图上的每一个点映射为三维空间中的一个曲面，多个曲面相交于一点，交点处的参数确定原图上的一个圆。同样，越多的曲面交于一点，检测出圆的真实性越高。下图中选取了原空间中的三个点 <img src="https://www.zhihu.com/equation?tex=%280%2C+4%29" alt="(0, 4)" eeimg="1"> , <img src="https://www.zhihu.com/equation?tex=%284%2C0%29" alt="(4,0)" eeimg="1"> 和 <img src="https://www.zhihu.com/equation?tex=%282%5Csqrt2%2C2%5Csqrt2%29" alt="(2\sqrt2,2\sqrt2)" eeimg="1"> 。很显然它们共圆的参数为 <img src="https://www.zhihu.com/equation?tex=a%3D0%2Cb%3D0%2Cr%3D4" alt="a=0,b=0,r=4" eeimg="1"> 。霍夫空间中的曲面像一个漏斗，顶点在AOB平面上的坐标即为原图点的二维坐标，曲面的交点可能不太明显，正是 <img src="https://www.zhihu.com/equation?tex=%280%2C0%2C4%29" alt="(0,0,4)" eeimg="1"> 。</p><figure data-size="normal"><noscript><img src="https://pica.zhimg.com/v2-861163a986ea681b49c75c40c6f958e5_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="2560" data-rawheight="698" class="origin_image zh-lightbox-thumb" width="2560" data-original="https://pic1.zhimg.com/v2-861163a986ea681b49c75c40c6f958e5_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='2560'%20height='698'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="2560" data-rawheight="698" class="origin_image zh-lightbox-thumb lazy" width="2560" data-original="https://pic1.zhimg.com/v2-861163a986ea681b49c75c40c6f958e5_720w.jpg?source=d16d100b" data-actualsrc="https://pica.zhimg.com/v2-861163a986ea681b49c75c40c6f958e5_720w.jpg?source=d16d100b"></figure><p data-pid="5EX02_Xi"><b>边缘检测算法</b>  在实际的圆检测中，我们不可能将所有点映射过去，它们全部相邻将没法计算。我们要做边缘检测来选取候选点。Python的OpenCV库中提供了相关检测函数，函数中使用了Canny边缘检测算法。它由John Canny在1986年提出的，是一个多阶段的算法，即由多个步骤构成：图像降噪、计算图像梯度、非极大值抑制、阈值筛选。下文参考了<a href="http://link.zhihu.com/?target=https%3A//blog.csdn.net/saltriver/article/details/80545571" class=" wrap external" target="_blank" rel="nofollow noreferrer">这篇文章</a>。</p><ul><li data-pid="N4Y--OwM">图像降噪</li></ul><p data-pid="x5jDJirB">我们知道梯度算子可以用于增强图像，但是它们受噪声的影响很大，因为噪声就是灰度变化很大的地方，所以容易被识别为伪边缘。Python的函数中实际不包含降噪这一步，我们可以在调用前添加一步灰度化和高斯滤波：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">'pu.jpg'</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
<span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div><ul><li data-pid="21lbvpag">计算图像梯度</li></ul><p data-pid="xd9pFZlR">图像边缘具有灰度变化明显的特点，梯度较大的位置就很可能是边缘。这一步筛选出边缘的候选集合。以下（包括本步骤）三个步骤都包含在库函数中了。</p><ul><li data-pid="NgI1Jnjo">非极大值抑制</li></ul><p data-pid="3FoRYgwr">通常灰度变化的地方都比较集中，将局部范围内的梯度方向上灰度变化最大的保留下来，其它的不保留，这样可以剔除掉一大部分的点。将有多个像素宽的边缘变成一个单像素宽的边缘。可以将梯度上升想象成爬山，灰度值就是海拔，原本很长的山坡，这里只取最陡峭的那一圈「等高线」。</p><ul><li data-pid="m0VbKBuB">双阈值筛选</li></ul><p data-pid="sErpofEi">通过非极大值抑制后，仍然有很多的边缘候选点。进一步设置双阈值，即低阈值和高阈值。灰度变化大于高阈值的，设置为强边缘像素；低于低阈值的，剔除。对于两者之间的设置为弱边缘进一步判断，如果其邻域内有强边缘像素则保留，否则剔除。</p><p data-pid="C-SmIPPc"><b>使用库函数</b>  理论的部分分析完毕，接下来做一个调包侠。之前说使用倾角拍照的效果不好，是因为那样得到的棋子是椭圆，而OpenCV中貌似没有椭圆检测函数。也可以想象椭圆方程具有四个参数，霍夫空间将变为四维，这将带来巨大的计算量。下面介绍cv2中的圆检测函数：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">cv2</span><span class="o">.</span><span class="n">HoughCircles</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">method</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">minDist</span><span class="p">[,</span> <span class="n">circles</span><span class="p">[,</span><span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">[,</span><span class="n">minRadius</span><span class="p">[,</span><span class="n">maxRadius</span><span class="p">]]]]])</span>
</code></pre></div><p data-pid="Yz48MhxH">霍夫圆变换的函数参数表如下：</p><table data-draft-node="block" data-draft-type="table" data-size="normal" data-row-style="normal"><tbody><tr><th>image</th><td>输入图像的二维矩阵</td></tr><tr><th>method</th><td>指定检测方法cv2.HOUGH_GRADIENT。目前OpenCV中只有霍夫梯度法</td></tr><tr><th>dp</th><td>图像分辨率与累加器分辨率的比值</td></tr><tr><th>minDist</th><td>圆心之间最小距离</td></tr><tr><th>param1</th><td>Canny边缘检测的双阈值中的高阈值，低阈值是它的一半</td></tr><tr><th>param2</th><td>最小投票数，基于圆心的投票数</td></tr><tr><th>minRadius</th><td>需要检测的圆的最小半径</td></tr><tr><th>maxRadius</th><td>需要检测的圆的最大半径</td></tr></tbody></table><p data-pid="Rqh4P3K6">分析完理论部分，这里的参数就很好理解了。需要注意的是其中param2这个投票数，指的其实就是霍夫空间中交于一点的曲面数，即达到这个阈值的我们才认为那里有圆。我们在实际应用时使用了大量的经验参数，这也是一个遗憾，注定开发得到的工具泛化能力不强。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">max_radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="o">*</span><span class="n">_gray</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">//</span> <span class="mi">19</span>
<span class="n">circles</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">HoughCircles</span><span class="p">(</span>
    <span class="n">image</span><span class="o">=</span><span class="n">_gray</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">HOUGH_GRADIENT</span><span class="p">,</span>
    <span class="n">dp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">minDist</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">param1</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">param2</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="n">minRadius</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">maxRadius</span><span class="o">=</span><span class="mi">30</span>
<span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">circles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">circles</span><span class="p">))</span>
</code></pre></div><p data-pid="201f7oPV">这里假设扫描照片的边缘与棋盘之间没有过多的空白，由于围棋棋盘为19路且相邻棋子紧挨着，所以圆的最大半径不会超过照片最小边长除以19。其余的参数是经过实验得到的经验值。这个函数的返回值circles是一个数组，每个元素是一个三元组，分别表示圆心的横坐标、纵坐标和圆的半径。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-61a685ec1eb34fc1b596d74bcc74391f_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="1165" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://picx.zhimg.com/v2-61a685ec1eb34fc1b596d74bcc74391f_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1080'%20height='1165'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="1165" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://picx.zhimg.com/v2-61a685ec1eb34fc1b596d74bcc74391f_720w.jpg?source=d16d100b" data-actualsrc="https://pic1.zhimg.com/v2-61a685ec1eb34fc1b596d74bcc74391f_720w.jpg?source=d16d100b"></figure><h3><b>2.3 数字识别：调用百度OCR接口</b></h3><p data-pid="DFWj6hzz"><a href="http://link.zhihu.com/?target=https%3A//ai.baidu.com/tech/ocr_others/numbers" class=" wrap external" target="_blank" rel="nofollow noreferrer">百度数字识别</a>可以对票据面单和仪表盘中的印刷体数字进行识别，过滤非数字内容，仅返回数字的位置和识别的结果，其声称准确率达到99%。从<a href="http://link.zhihu.com/?target=https%3A//ai.baidu.com/ai-doc/OCR/fk3h7xu7h" class=" wrap external" target="_blank" rel="nofollow noreferrer">定价文档</a>中可以看到每天的免费额度只有200次，由于一盘棋平均就有200步以上，逐步识别显然不可行。</p><p data-pid="ndVAL7KK">我尝试将棋子上的步数进行拼接后批量识别。实验结果表明，横向并列得到的结果准确但无法分割，纵向拼接能得到分割的结果但可能会丢掉某些数字。后来我也发现这种丢失可能不是拼接导致的，而是数字本身无法识别，那么配合结果中的位置参数实际可以分析出识别失败的数字。我最初实验时不知道这一点，所以还是采用了逐步识别，那么我们就需要想办法白嫖。</p><p data-pid="yCUSaupz">上面给出的链接中有一个演示功能，我们爬取识别请求的流量包，可以发现是个简单的POST方法。分析一下返回值的结构，我们可以写出以下提取数字的程序：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="k">def</span> <span class="nf">extract_number</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">retval</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imencode</span><span class="p">(</span><span class="s1">'.png'</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
    <span class="n">pic_str</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"https://ai.baidu.com/aidemo"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"image"</span><span class="p">:</span> <span class="s2">"data:image/png;base64,"</span> <span class="o">+</span> <span class="n">pic_str</span><span class="p">,</span>
        <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"https://aip.baidubce.com/rest/2.0/ocr/v1/numbers"</span>
    <span class="p">})</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">'data'</span><span class="p">][</span><span class="s1">'words_result'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'words'</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
</code></pre></div><p data-pid="Ai9RfyWr">请求中image参数是图像base64编码的字符串，请求的接口为aidemo。识别失败时我们返回异常值0，因为棋谱的步数中不会有0。这里要注意请求频率不能过高，我在主函数中使用了0.5秒的延时刚刚好。如果频率过高，百度将会封禁IP一段时间。由于这个请求连cookie都不需要，完全是公开的，封禁的时间也不会太长。</p><p data-pid="4-U7m1Go">这里的img参数是一个numpy数组，我们可以根据之前霍夫圆检测得到的信息进行抠图。经验表明，使用原始图像抠图，比高斯模糊后的识别效果更好。之前的实验中我还将抠出的棋子图片进行二值化，并将黑棋颜色翻转，将圆外背景涂白，最终得到完全白底黑字的图片，现在看来并无必要，这里不再赘述。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">circles</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">gray</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s2">"_image"</span><span class="p">:</span> <span class="n">img</span><span class="p">,</span>
        <span class="s2">"number"</span><span class="p">:</span> <span class="n">extract_number</span><span class="p">(</span><span class="n">img</span><span class="p">),</span>
        <span class="s2">"center"</span><span class="p">:</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="s2">"radius"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">'number'</span><span class="p">]:</span> <span class="n">broken</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</code></pre></div><p data-pid="HZsqAySl">实际识别的效果并不像想象中那么好，对于数字1和4的检测经常遗漏，但所幸没有识别上的错误。于是我添加了一步对未能识别的步数手动补齐。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%d</span><span class="s2"> images need manual repair ..."</span> <span class="o">%</span> <span class="n">broken</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'number'</span><span class="p">]:</span>
        <span class="n">console_imshow</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'_image'</span><span class="p">])</span>
        <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'number'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">"[</span><span class="si">%3d</span><span class="s2"> left] Input Number &gt;&gt;&gt; "</span> <span class="o">%</span> <span class="n">broken</span><span class="p">))</span>
        <span class="c1"># os.system("clear")</span>
        <span class="n">broken</span> <span class="o">-=</span> <span class="mi">1</span>
</code></pre></div><p data-pid="E16axnFk">这里的console_imshow是一个简单的字符画输出，整个识别过程是在控制台完成的。然后我们将steps按照步数排序，使用pickle固化成二进制的中间文件。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">'number'</span><span class="p">]))</span>
<span class="n">pkl_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'steps.pkl'</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkl_name</span><span class="p">,</span><span class="s1">'wb'</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Index file successfully saved as </span><span class="si">%s</span><span class="s2">!"</span> <span class="o">%</span> <span class="n">pkl_name</span><span class="p">)</span>
</code></pre></div><h3><b>2.4 可视化输出：编写QT界面</b></h3><p data-pid="b8At-ugh">可视化编程这里没什么好说的，主要思想是，在原始图像上按照顺序圈出所有的步数，可以通过按钮控制上一步下一步，也可以通过输入框转到指定的步数。每次步数变化时，对原始图像进行拷贝，使用CV2绘制圆形，然后重新加载到ImageLabel上面。</p><p data-pid="m5we7ial">这里为了健壮性考虑，转到的步数不是真实的步数，而是该步在steps列表中的索引。有些步数识别错误或者被漏掉会导致索引与步数不一致，如果使用步数做转到功能，很有可能无法执行。两者相差不会很大，可以通过转到功能找到大概范围，再使用上一步下一步微调。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-a10bd2cb86edde646df9195d9901b83e_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="2560" data-rawheight="1600" class="origin_image zh-lightbox-thumb" width="2560" data-original="https://picx.zhimg.com/v2-a10bd2cb86edde646df9195d9901b83e_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='2560'%20height='1600'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="2560" data-rawheight="1600" class="origin_image zh-lightbox-thumb lazy" width="2560" data-original="https://picx.zhimg.com/v2-a10bd2cb86edde646df9195d9901b83e_720w.jpg?source=d16d100b" data-actualsrc="https://pic1.zhimg.com/v2-a10bd2cb86edde646df9195d9901b83e_720w.jpg?source=d16d100b"></figure><p data-pid="ue6eZorD">最终的实验效果比我料想的要好，我也很快地打完了开篇说的那一局棋。我尝试了这本书上的三个不同的棋谱效果都很好，虽有小错，对打谱起到了绝对的辅助作用。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-ea40dd71f8f2bbf81fffbc49495508e4_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="1620" data-rawheight="1546" class="origin_image zh-lightbox-thumb" width="1620" data-original="https://pic1.zhimg.com/v2-ea40dd71f8f2bbf81fffbc49495508e4_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1620'%20height='1546'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1620" data-rawheight="1546" class="origin_image zh-lightbox-thumb lazy" width="1620" data-original="https://pic1.zhimg.com/v2-ea40dd71f8f2bbf81fffbc49495508e4_720w.jpg?source=d16d100b" data-actualsrc="https://pic1.zhimg.com/v2-ea40dd71f8f2bbf81fffbc49495508e4_720w.jpg?source=d16d100b"></figure><h2>3 失败尝试</h2><p data-pid="msCmX3OG">调用百度的API也是不得已之举，之前的实验十分失败，让我差点想放弃这个项目。两天的时间，前一天半都在研究数字识别。最初我认为印刷体比手写识别更难，于是尝试使用MNIST数据集训练的神经网络直接进行预测。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">mnist</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span>

<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mf">255.0</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">'relu'</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">'softmax'</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="s1">'adam'</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="s1">'sparse_categorical_crossentropy'</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">'accuracy'</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div><p data-pid="A00QG_KX">这里我首先进行了数字的分割，得到0-9的个位数字。然后为了将原图裁成统一的28x28的标准数据使用了比较复杂的算法。大致思想是，找到一个比图像边长略小的28的整数倍，看看边长超出的比例占多少。如果比例小于0.2，则掐头去尾，然后对整体进行降采样；如果比例高，则首尾做等量padding，然后再降采样。这里不展开那个冗长的代码了，毕竟这部分整体失败了。</p><p data-pid="g48pGn70">取待识别数据的前20个肉眼观察一下效果。先将原图展平成(1, 784)，然后进行反色，也就是变成黑底白字，然后归一化，最后使用模型进行预测，取预测结果向量中概率最大的类别。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">number</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
    <span class="n">cv2_imshow</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span>
</code></pre></div><p data-pid="FHM28N8q">可以从结果中看出，预测效果并不令人满意。主要问题集中在，模型无法区分1和7。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-df864862063b60a1562eb4f8a896af4b_720w.jpeg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="1490" data-rawheight="76" class="origin_image zh-lightbox-thumb" width="1490" data-original="https://picx.zhimg.com/v2-df864862063b60a1562eb4f8a896af4b_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1490'%20height='76'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1490" data-rawheight="76" class="origin_image zh-lightbox-thumb lazy" width="1490" data-original="https://picx.zhimg.com/v2-df864862063b60a1562eb4f8a896af4b_720w.jpg?source=d16d100b" data-actualsrc="https://pic1.zhimg.com/v2-df864862063b60a1562eb4f8a896af4b_720w.jpeg?source=d16d100b"></figure><p data-pid="ZwAN6E3R">也难怪，这里印刷体的1也带一个弯钩，由于MNIST数据集有旋转，侧着看确实像手写的7。接下来我尝试使用相近字体自动生成数据集。据我分析，这个字体和<code>Arial Narrow Bold</code>很接近，于是使用PIL库自动生成了10个数字的样板：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">train_X</span><span class="p">,</span> <span class="n">train_y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="s2">"Arial Narrow Bold.ttf"</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"L"</span><span class="p">,</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">"#000000"</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">train_X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">train_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">train_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_X</span><span class="p">)</span>
<span class="n">train_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_y</span><span class="p">)</span> 
</code></pre></div><p data-pid="7rx7XQZy">由于我只有10个样本，不可能去搞神经网络，所以第一想法是使用k=1的K-NN尝试一下直接近似度匹配，但效果同样不佳。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-61f9e483454219cd5f09beffcb819cb5_720w.jpeg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="1480" data-rawheight="68" class="origin_image zh-lightbox-thumb" width="1480" data-original="https://pic1.zhimg.com/v2-61f9e483454219cd5f09beffcb819cb5_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1480'%20height='68'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1480" data-rawheight="68" class="origin_image zh-lightbox-thumb lazy" width="1480" data-original="https://pic1.zhimg.com/v2-61f9e483454219cd5f09beffcb819cb5_720w.jpg?source=d16d100b" data-actualsrc="https://pic1.zhimg.com/v2-61f9e483454219cd5f09beffcb819cb5_720w.jpeg?source=d16d100b"></figure><p data-pid="rdDVJWe9">可以看到这回问题主要出在1和4无法区分，这是由于我生成的样本的字号和测试数据集不同。尝试使用18px到28px的字号生成100个样本后，发现效果不但未提升，反而下降了。不同样本的数字位置不统一，大小也不统一，甚至粗细都不同。个位数的步数字号大，三位数的步数字号小很多；为了阅读体验，黑棋步数明显比白棋粗。这个问题恐怕只能使用神经网络进行针对性的训练，然而在手动制作数据集时又发现了令我崩溃的问题：数字的分割就无法做到完全准确，更不要提数据在不同类别上数量分布不平衡。</p><p data-pid="fXKuPgnR">绝大多数的数字都可以分开，但96这样的数字就让我头疼很久。因为他们中间没有空隙，两个圆滚滚的数字粘在一起，我是真的没想到什么算法能把它们分开。我一开始只是用上升沿检测和灰度阈值的方法，现在也都无能为力。于是我明白了，分割本身也是需要网络的，可以使用3个像素宽的滑动窗口进行采样，对正确的分割位置进行标注，这就是一个二分类问题。面对浩大的数据集制作工作，不得不放弃。因为784维的特征怎么也需要几千个样本，然而最终能做的事情也不过是局限在这本书中，换一个印刷字体立马失效。于是我就想到了调接口的方法，毕竟人家的数据量和算力不是我们可以比拟的。</p><h2>4 未来工作</h2><ul><li data-pid="o79xkUeg">修改逐步识别为批量识别，减少网络请求数量，大幅降低延迟。</li><li data-pid="XbPX9WPW">通过棋子圆心的相对位置推算棋盘上的绝对位置坐标，以实现棋谱的完全的电子化。这样也可以为自制拍照数目的工具做铺垫。野狐围棋上的AI数子是有次数限制的。</li><li data-pid="6SAAll_o">制作专门的数据集，以提高识别算法的准确率和泛化能力。</li><li data-pid="1bcYQdcE">对识别的神经网络模型进行压缩，在手机上部署，实现完全的本地计算以降低时延。</li></ul><h2>附录A：完整代码</h2><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># test.py</span>
<span class="kn">import</span> <span class="nn">cv2</span><span class="o">,</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pickle</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">mul</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">extract_number</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">retval</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imencode</span><span class="p">(</span><span class="s1">'.png'</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
    <span class="n">pic_str</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"https://ai.baidu.com/aidemo"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"image"</span><span class="p">:</span> <span class="s2">"data:image/png;base64,"</span> <span class="o">+</span> <span class="n">pic_str</span><span class="p">,</span>
        <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"https://aip.baidubce.com/rest/2.0/ocr/v1/numbers"</span>
    <span class="p">})</span>
    <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">'data'</span><span class="p">][</span><span class="s1">'words_result'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'words'</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">console_imshow</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">img</span><span class="p">[::</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">"M"</span> <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">128</span> <span class="k">else</span> <span class="s2">" "</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">'To find steps more easily'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--image'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'Image file obtained by scanning a Go note'</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">max_radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="o">*</span><span class="n">_gray</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">//</span> <span class="mi">19</span>
    <span class="n">circles</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">HoughCircles</span><span class="p">(</span>
        <span class="n">image</span><span class="o">=</span><span class="n">_gray</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">HOUGH_GRADIENT</span><span class="p">,</span>
        <span class="n">dp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minDist</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">param1</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">param2</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">minRadius</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">maxRadius</span><span class="o">=</span><span class="mi">30</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">circles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">circles</span><span class="p">))</span>

    <span class="n">steps</span><span class="p">,</span> <span class="n">broken</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">circles</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">gray</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span> <span class="k">if</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;</span> <span class="mi">130</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">mul</span><span class="p">(</span><span class="o">*</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">else</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY_INV</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radius</span> <span class="o">-</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">img</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">"_image"</span><span class="p">:</span> <span class="n">img</span><span class="p">,</span>
            <span class="s2">"number"</span><span class="p">:</span> <span class="n">extract_number</span><span class="p">(</span><span class="n">img</span><span class="p">),</span>
            <span class="s2">"center"</span><span class="p">:</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s2">"radius"</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">'number'</span><span class="p">]:</span> <span class="n">broken</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%d</span><span class="s2"> images need manual repair ..."</span> <span class="o">%</span> <span class="n">broken</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'number'</span><span class="p">]:</span>
            <span class="n">console_imshow</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'_image'</span><span class="p">])</span>
            <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'number'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">"[</span><span class="si">%3d</span><span class="s2"> left] Input Number &gt;&gt;&gt; "</span> <span class="o">%</span> <span class="n">broken</span><span class="p">))</span>
            <span class="c1"># os.system("clear")</span>
            <span class="n">broken</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">'number'</span><span class="p">]))</span>
    <span class="n">pkl_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'steps.pkl'</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkl_name</span><span class="p">,</span><span class="s1">'wb'</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Index file successfully saved as </span><span class="si">%s</span><span class="s2">!"</span> <span class="o">%</span> <span class="n">pkl_name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Use Command `python show.py --image </span><span class="si">%s</span><span class="s2">` to launch the gui tool~"</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</code></pre></div><p><br></p><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># show.py</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtWidgets</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">pickle</span><span class="o">,</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">cv2</span>  

<span class="k">class</span> <span class="nc">Ui_MainWindow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MainWindow</span><span class="p">):</span>
		<span class="n">MainWindow</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">"MainWindow"</span><span class="p">)</span>
		<span class="n">MainWindow</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">centralwidget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">(</span><span class="n">MainWindow</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">centralwidget</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">"centralwidget"</span><span class="p">)</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">imageLabel</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centralwidget</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">imageLabel</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">imageLabel</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">"imageLabel"</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">nextButton</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centralwidget</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nextButton</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QRect</span><span class="p">(</span><span class="mi">620</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nextButton</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">"nextButton"</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevButton</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centralwidget</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevButton</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QRect</span><span class="p">(</span><span class="mi">620</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevButton</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">"prevButton"</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centralwidget</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QRect</span><span class="p">(</span><span class="mi">627</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">26</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">"lineEdit"</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span><span class="o">.</span><span class="n">setValidator</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QIntValidator</span><span class="p">())</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">specButton</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centralwidget</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">specButton</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QRect</span><span class="p">(</span><span class="mi">720</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">specButton</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">"specButton"</span><span class="p">)</span>

		<span class="n">MainWindow</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centralwidget</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">retranslateUi</span><span class="p">(</span><span class="n">MainWindow</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nextButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">MainWindow</span><span class="o">.</span><span class="n">next_step</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">MainWindow</span><span class="o">.</span><span class="n">prev_step</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">specButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">MainWindow</span><span class="o">.</span><span class="n">spec_step</span><span class="p">)</span>
		<span class="n">QtCore</span><span class="o">.</span><span class="n">QMetaObject</span><span class="o">.</span><span class="n">connectSlotsByName</span><span class="p">(</span><span class="n">MainWindow</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">retranslateUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MainWindow</span><span class="p">):</span>
		<span class="n">_translate</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span>
		<span class="n">MainWindow</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">_translate</span><span class="p">(</span><span class="s2">"MainWindow"</span><span class="p">,</span> <span class="s2">"围棋打谱助手"</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nextButton</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">_translate</span><span class="p">(</span><span class="s2">"MainWindow"</span><span class="p">,</span> <span class="s2">"下一步"</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevButton</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">_translate</span><span class="p">(</span><span class="s2">"MainWindow"</span><span class="p">,</span> <span class="s2">"上一步"</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">specButton</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">_translate</span><span class="p">(</span><span class="s2">"MainWindow"</span><span class="p">,</span> <span class="s2">"转到"</span><span class="p">))</span>
 

<span class="k">class</span> <span class="nc">mywindow</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMainWindow</span><span class="p">,</span> <span class="n">Ui_MainWindow</span><span class="p">):</span>
	
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">global</span> <span class="n">args</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">mywindow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
			<span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'steps.pkl'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">step_now</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">next_step</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
		<span class="n">img_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2BGRA</span><span class="p">)</span>
		<span class="n">img_qt</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="p">(</span><span class="n">img_rgb</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">img_rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="o">.</span><span class="n">Format_RGB32</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">imageLabel</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span>
			<span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="o">.</span><span class="n">fromImage</span><span class="p">(</span><span class="n">img_qt</span><span class="p">)</span><span class="o">.</span><span class="n">scaled</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">imageLabel</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageLabel</span><span class="o">.</span><span class="n">height</span><span class="p">()))</span>

	<span class="k">def</span> <span class="nf">draw_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">step_now</span><span class="p">][</span><span class="s1">'center'</span><span class="p">]</span>
		<span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">step_now</span><span class="p">][</span><span class="s1">'radius'</span><span class="p">]</span>
		<span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">254</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">next_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">step_now</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_now</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">prev_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">step_now</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_now</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">spec_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
		<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">step</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">step_now</span> <span class="o">=</span> <span class="n">step</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">()</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">'To find steps more easily'</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--image'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'Image file obtained by scanning a Go note'</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
<span class="n">window</span> <span class="o">=</span> <span class="n">mywindow</span><span class="p">()</span>
<span class="n">window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span>
</code></pre></div><h2>附录B：数字分割与图像缩放代码</h2><p data-pid="WUEySOph">这部分没用，在此记录一下害怕以后丢了</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">step</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">is_white</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">4</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">is_white</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_white</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]):</span>
        <span class="n">index_l</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">if</span> <span class="n">is_white</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_white</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="n">number</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">index_l</span><span class="p">:</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">number</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">28</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">length</span> <span class="o">*</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">j</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">k</span> <span class="o">*</span> <span class="n">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">div</span> <span class="o">+</span> <span class="n">mod</span><span class="p">:</span>
                <span class="n">number</span> <span class="o">=</span> <span class="n">number</span><span class="p">[</span><span class="n">div</span><span class="p">:</span> <span class="o">-</span><span class="p">(</span><span class="n">div</span> <span class="o">+</span> <span class="n">mod</span><span class="p">):</span> <span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">number</span> <span class="o">=</span> <span class="n">number</span><span class="p">[</span><span class="n">div</span><span class="p">::</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">((</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">length</span> <span class="o">-</span> <span class="n">height</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="p">((</span><span class="n">div</span><span class="p">,</span> <span class="n">div</span><span class="o">+</span><span class="n">mod</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="s1">'constant'</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
            <span class="n">number</span> <span class="o">=</span> <span class="n">number</span><span class="p">[::</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="p">:</span>
            <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">width</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="n">div</span><span class="o">+</span><span class="n">mod</span><span class="p">)),</span> <span class="s1">'constant'</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
            <span class="n">step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">length</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">number</span> <span class="o">=</span> <span class="n">number</span><span class="p">[</span><span class="n">div</span><span class="p">:</span> <span class="o">-</span><span class="p">(</span><span class="n">div</span> <span class="o">+</span> <span class="n">mod</span><span class="p">),</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">half</span> <span class="o">=</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">num_1</span><span class="p">,</span> <span class="n">num_2</span> <span class="o">=</span> <span class="n">number</span><span class="p">[:,</span> <span class="p">:</span><span class="n">half</span><span class="p">],</span> <span class="n">number</span><span class="p">[:,</span> <span class="n">half</span><span class="p">:]</span>
            <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">half</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">num_1</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="n">div</span><span class="o">+</span><span class="n">mod</span><span class="p">)),</span> <span class="s1">'constant'</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
            <span class="n">step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
            <span class="n">number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">num_2</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="n">div</span><span class="o">+</span><span class="n">mod</span><span class="p">)),</span> <span class="s1">'constant'</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
            <span class="n">step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
</code></pre></div><p></p>