<h2>写在前面</h2><p data-pid="IsOLkmdy">生活中不可避免会出现换手机号的需求，例如更换常住城市之后一般会新办一个本地号码，一方面原来的号码可能网络覆盖不佳（当然也可以办理携号转网），另一方面外地号码很多人会拒接。</p><p data-pid="UlNSGx4M">阻止我们换号的首要难题就是，<b>原来的号码用了很多年，实在想不起来都注册过什么网站、APP了</b>。这既不方便，也不安全：一是号码注销之后，很多应用没法改绑导致<b>账号丢失</b>，二是号码的新主人可能会<b>盗用账号</b>。</p><p data-pid="_hJRW0aV">说点题外话，解决以上问题最简单的办法其实是停机保号，或者办一个价格极低的基础套餐，只接收验证码。但我最近却遇到一个不太罕见但十分棘手的问题——靓号低消，可以称之为运营商明地里违规的霸王条款。</p><p data-pid="rhMI0kGm">当年买号码时没有任何提醒，最初几年有返现，当返现结束，话费就恢复成天价。最重要的是，套餐缴费不足最低消费标准的，要补上承诺补差，而协议期在 20 年到 60 年不等，可以说真的是“一号传三代，人死号还在”。取决于号码“靓”的程度，低消有 129、199、299 等每月不同的价位，如果说靓号的意义就在于好记、有面子，那么话费高点也就还好。但协议期内低消无法取消，就算你办了停机保号只接收验证码，一个月该交 299 还得交。没有人能打通你的号码，意味着没有人会赏脸去记它，但靓号还是靓号。</p><p data-pid="Qn72tv05">2007 年，信产部发布《关于降低<span class="nolink">移动电话</span>停机保号业务资费上限标准的通知》，将资费降到5元每月。维权先驱 <a href="http://link.zhihu.com/?target=https%3A//baike.baidu.com/item/%25E6%2588%25B4%25E5%2585%2583%25E9%25BE%2599/0%3FfromModule%3Dlemma_inlink" class=" wrap external" target="_blank" rel="nofollow noreferrer">戴元龙</a> 向信产部发出了《行政请求书》，指出根据《电信网<span class="nolink">码号资源占用费</span>征收管理暂行办法》第十五条规定，“码号资源占用费由占有、使用码号资源的电信业务经营者承担，电信业务经营者不得向电信用户收取码号资源占用费。”停机保号费违反了《<span class="nolink">中华人民共和国电信条例</span>》第四十一条第一款第三项“电信业务经营者在电信服务中，不得违反国家规定，擅自改变或者变相改变资费标准，擅自增加或者变相增加收费项目”。那么，299元每月的资费是否违反上述规定呢？</p><p data-pid="AUDwSJ1s">这件事的解法很简单，我打客服电话投诉，声称要根据以上条例起诉该运营商的省分公司，那边当天就派了专员来帮我解除低消。然而，客服要求我发送合同（签字、按手印）、手持身份证照片、手持合同照片，要知道这些信息完全足以在我不知情的情况下办网贷了，客服没能提供令我信服的工作证明，这件事就此搁置。</p><p data-pid="Vgiwa6mQ">于是，话说回来，我想到直接销号。也许可以通过对手机的信息采集，分析出我都注册过哪些账号。<b>如果我是通过手机号、验证码的方式注册的账号，那么只要从所有的验证码短信中抽取出网站列表不就可以了吗？</b>作为补充，再将所有<b>用过的 APP 列表</b>抽取出来，将<b>浏览器保存的账号</b>抽取出来，几乎可以覆盖所有账号了。</p><p data-pid="wK80dn33">其中，短信、APP 浩如烟海，必然使用程序进行自动化分析。技术路线也很简单，使用 Python 调用 Android Debug Bridge（adb）抽取原始数据，然后使用 Pyparsing 对文本进行解析，使用 Pandas 数据处理。</p><h2>实验环境</h2><p data-pid="42O3OamN">要注销的手机卡：电信 x1、移动 x1</p><p data-pid="NJArI1J7">使用过这些手机卡的手机：小米 10 pro、小米 14</p><p data-pid="COFeYh6L">上位机：Windows 11 / MacOS（下文主要使用 Win11，终端使用 Powershell 7）</p><p data-pid="wg006vu0">我其实还有两部手机用过这两张卡，但是一部丢了，另一部是华为 nova 2 plus，不支持 adb 获取短信内容。nova 2 的系统最高版本就是 Android 8，获取短信内容需要 root 权限，而华为的手机又是众所周知很难 root 的，所以只能放弃了。对于短信，我使用滚动截屏 +OCR（微信内置）的方法，对于应用就肉眼看啦。</p><h2>实验步骤</h2><h3>adb 安装与无线调试</h3><p data-pid="B7n6zpN2">根据上位机操作系统，下载 adb 最新的 <a href="http://link.zhihu.com/?target=https%3A//dl.google.com/android/repository/platform-tools-latest-windows.zip" class=" wrap external" target="_blank" rel="nofollow noreferrer">Windows 版本</a> 或 <a href="http://link.zhihu.com/?target=https%3A//dl.google.com/android/repository/platform-tools-latest-darwin.zip" class=" wrap external" target="_blank" rel="nofollow noreferrer">Mac 版本</a> ，解压得到 platform-tools 文件夹。文件夹中有 adb 的可执行文件，可以把这个路径添加到系统环境变量中，也可以不添加。在终端中进入该文件夹，并验证 adb 可以执行：</p><div class="highlight"><pre><code class="language-powershell"><span></span><span class="nb">cd </span><span class="n">platform-tools</span> <span class="p">&amp;&amp;</span> <span class="n">adb</span> <span class="p">-</span><span class="n">-version</span>
<span class="p">----------------------------------</span>
<span class="n">Android</span> <span class="n">Debug</span> <span class="n">Bridge</span> <span class="n">version</span> <span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">41</span>
<span class="n">Version</span> <span class="n">35</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">-</span><span class="n">12147458</span>
<span class="n">Installed</span> <span class="n">as</span> <span class="n">D</span><span class="err">:</span><span class="p">\</span><span class="n">softwares</span><span class="p">\</span><span class="n">adb</span><span class="p">\</span><span class="n">adb</span><span class="p">.</span><span class="n">exe</span>
<span class="n">Running</span> <span class="n">on</span> <span class="n">Windows</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">22631</span>
</code></pre></div><p data-pid="dfVIEMw0">可以看到 adb 的版本为 35.0.2。由于我们要使用无线调试的方式，要求 adb 版本 ≥ 30.0.0，安卓系统为 11 及更高版本。在无线调试之前，我们还要将上位机和被调试的手机置于同一个局域网中（同一 WiFi / 热点 下）。</p><p data-pid="TABA4ayf">接下来打开手机的开发者模式，小米 HyperOS 的后门在：设置 &gt; 我的设备 &gt; 全部参数与信息 &gt; OS 版本，连续点击 OS 版本大概 7 次，手机提示“您现在处于开发者模式”。当然，当手机已经处于开发者模式时，这里不会有反应，直接在设置中搜索“开发者”就可以看到“开发者选项”已打开。</p><p data-pid="9IKMVoln">在设置中搜索“无线调试”，开启之后可以在下面看到 IP 地址和端口。第一次配对时不使用该端口，而是点击“使用配对码配对设备”，弹窗里有一个 WLAN 配对码，以及一个动态的 IP 地址和端口。这里要格外注意，“动态”意味着一旦取消并重新点击配对码，会动态生成一个新的配对码和新的端口。</p><p data-pid="c57KF5k1">在上位机的终端连接该设备：</p><div class="highlight"><pre><code class="language-powershell"><span></span><span class="n">adb</span> <span class="n">pair</span> <span class="p">&lt;</span><span class="n">IP_ADDRESS</span><span class="p">&gt;</span><span class="err">:</span><span class="p">&lt;</span><span class="n">PORT</span><span class="p">&gt;</span>
<span class="p">----------------------------------</span>
<span class="n">Enter</span> <span class="n">pairing</span> <span class="n">code</span><span class="err">:</span><span class="n">000000</span>
<span class="n">Successfully</span> <span class="n">paired</span> <span class="n">to</span> <span class="p">&lt;</span><span class="n">IP_ADDRESS</span><span class="p">&gt;</span><span class="err">:</span><span class="p">&lt;</span><span class="n">PORT</span><span class="p">&gt;</span>
</code></pre></div><p data-pid="Gbk03pov">在提示“Enter pairing code:”之后输入配对码。连接成功后，手机的弹窗会自动消失，在“已配对的设备”那里可以看到当前上位机的名称。同时，上位机提示成功连接。使用以下命令查看已连接的设备</p><div class="highlight"><pre><code class="language-powershell"><span></span><span class="n">adb</span> <span class="n">devices</span>
<span class="p">----------------------------------</span>
<span class="n">List</span> <span class="n">of</span> <span class="n">devices</span> <span class="n">attached</span>
<span class="n">adb-fdf48c08-L0dh9H</span><span class="p">.</span><span class="n">_adb-tls-connect</span><span class="p">.</span><span class="n">_tcp</span><span class="no">[example]</span>    <span class="n">device</span>
</code></pre></div><p data-pid="9lGZ3gmg">如果想要断开连接，使用以下命令断开指定的设备</p><div class="highlight"><pre><code class="language-powershell"><span></span><span class="n">adb</span> <span class="n">-s</span> <span class="n">adb-fdf48c08-L0dh9H</span><span class="p">.</span><span class="n">_adb-tls-connect</span><span class="p">.</span><span class="n">_tcp</span><span class="no">[example]</span>  <span class="n">disconnect</span>
</code></pre></div><p data-pid="A9rukyje">当上位机已经和手机配对后，就不需要配对码，可以直接</p><div class="highlight"><pre><code class="language-powershell"><span></span><span class="n">adb</span> <span class="n">connect</span> <span class="p">&lt;</span><span class="n">IP_ADDRESS</span><span class="p">&gt;</span><span class="err">:</span><span class="p">&lt;</span><span class="n">PORT</span><span class="p">&gt;</span>
</code></pre></div><p data-pid="SgO819Uo">这时如果再查看当前已连接设备，会发现设备的 ID 和原来不太一样，变成了</p><div class="highlight"><pre><code class="language-text"><span></span>adb devices
----------------------------------
List of devices attached
&lt;IP_ADDRESS&gt;:&lt;PORT&gt;    device
</code></pre></div><h3>Python 调用 adb</h3><p data-pid="W6hUy4Oj">这里，我们不使用现有的 Python adb 库，而是直接使用子进程库 subprocess 来完成调用，这样不需要参考文档，性能上也更好一些。我们定义一个 AndroidDebugBridge 类，在构造时传入 adb 可执行文件的绝对路径。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="k">class</span> <span class="nc">AndroidDebugBridge</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adb_exe</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb_exe</span> <span class="o">=</span> <span class="n">adb_exe</span>

    <span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">adb_exe</span><span class="p">]</span> <span class="o">+</span> <span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"When running command `</span><span class="si">{command}</span><span class="s2">`,</span><span class="se">\n</span><span class="s2">An error occurred: </span><span class="si">{e}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"&gt;&gt;&gt; adb </span><span class="si">{command}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
</code></pre></div><p data-pid="AmRyQzLQ">run_command 是核心函数，通过 <span class="nolink">subprocess.run</span> 来完整执行一个系统命令，并获取其输出。命令以列表的形式传入，相当于把终端的命令字符串按照空格切分成了不同的部分。这个函数会等待子进程执行完毕后返回结果。</p><p data-pid="3K2iEt7I">我们可以将以上无线调试连接设备的命令写成方法：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="k">class</span> <span class="nc">AndroidDebugBridge</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">connet_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"connect {':'.join(address)}"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pair_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">pairing_code</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"&gt;&gt;&gt; adb pair {':'.join(address)}"</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">adb_exe</span><span class="p">,</span> <span class="s2">"pair"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"{':'.join(address)}"</span><span class="p">,</span> <span class="n">pairing_code</span><span class="p">],</span> 
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">pairing_code</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">disconnect_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">"devices"</span><span class="p">)</span>
        <span class="n">device_id</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"-s </span><span class="si">{device_id}</span><span class="s2"> disconnect"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div><p data-pid="NUqfu2km">注意，在首次连接设备时我们使用 pair_device 方法。使用 subprocess.Popen 开启子进程的好处是，可以与子进程做输入输出交互。在连接已配对的设备时，pair_device 可能没效果，使用 connect_device 连接。</p><h3>从短信中分析账号</h3><div class="highlight"><pre><code class="language-python"><span></span><span class="k">class</span> <span class="nc">AndroidDebugBridge</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">get_sms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofstream</span><span class="p">:</span>
            <span class="c1"># Add --projection &lt;field1,field2,...&gt; to select a subset of fields</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">"shell content query --uri content://sms"</span><span class="p">)</span>
            <span class="n">ofstream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</code></pre></div><p data-pid="G65IDhe6">直接将短信存入指定的文件。我们可以分别将不同手机的短信收集到文件，然后对这些文本文件进行合并。我是直接使用 Powershell 进行合并的（当然，这里要注意，对于双卡双待的手机，要确保不同手机上的1卡和2卡的号码对应相同）：</p><div class="highlight"><pre><code class="language-powershell"><span></span><span class="nb">get-Content</span> <span class="s2">".\sms_mi10pro.data"</span><span class="p">,</span> <span class="s2">".\sms_mi14.data"</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="s2">"sms.data"</span>
</code></pre></div><p data-pid="jgafl_3Q">用 VSCode 或者 Sublime 打开 sms.data，可以看到内部每条信息的格式类似如下：</p><div class="highlight"><pre><code class="language-text"><span></span>Row: 0 _id=8939, thread_id=1535, address=1069375277198, person=NULL, date=1732587164372, date_sent=1732587164372, protocol=0, read=1, status=-1, type=1, reply_path_present=0, subject=NULL, body=【小米游戏】《火柴人联盟3》官宣定档12.26！享受极致微操的热血格斗盛宴！奥义挑战深渊巨兽，海量装备轻松获取！拒收请回复R&gt;&gt;s.mi.cn/migame/4UxE90Y3 , service_center=miPush, locked=0, error_code=0, seen=1, timed=0, deleted=0, sync_state=0, marker=0, source=NULL, bind_id=0, mx_status=0, mx_id=NULL, out_time=0, account=NULL, sim_id=1, block_type=0, advanced_seen=3, b2c_ttl=0, b2c_numbers=1069375277198, fake_cell_type=0, url_risky_type=0, creator=NULL, favorite_date=0, mx_id_v2=NULL, sub_id=1
</code></pre></div><p data-pid="XUUxWZ_T">开头的 Row: 0 表示第 0 行，然后是逗号隔开的多个字段，每个字段的关键字和值之间由等号连接。以下是字段列表。可以保证每条信息都有以下字段，不存在缺省。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"_id"</span><span class="p">,</span> <span class="s2">"thread_id"</span><span class="p">,</span> <span class="s2">"address"</span><span class="p">,</span> <span class="s2">"person"</span><span class="p">,</span> <span class="s2">"date"</span><span class="p">,</span> <span class="s2">"date_sent"</span><span class="p">,</span> <span class="s2">"protocol"</span><span class="p">,</span>
               <span class="s2">"read"</span><span class="p">,</span> <span class="s2">"status"</span><span class="p">,</span> <span class="s2">"type"</span><span class="p">,</span> <span class="s2">"reply_path_present"</span><span class="p">,</span> <span class="s2">"subject"</span><span class="p">,</span> <span class="s2">"body"</span><span class="p">,</span>
               <span class="s2">"service_center"</span><span class="p">,</span> <span class="s2">"locked"</span><span class="p">,</span> <span class="s2">"error_code"</span><span class="p">,</span> <span class="s2">"seen"</span><span class="p">,</span> <span class="s2">"timed"</span><span class="p">,</span> <span class="s2">"deleted"</span><span class="p">,</span>
               <span class="s2">"sync_state"</span><span class="p">,</span> <span class="s2">"marker"</span><span class="p">,</span> <span class="s2">"source"</span><span class="p">,</span> <span class="s2">"bind_id"</span><span class="p">,</span> <span class="s2">"mx_status"</span><span class="p">,</span> <span class="s2">"mx_id"</span><span class="p">,</span>
               <span class="s2">"out_time"</span><span class="p">,</span> <span class="s2">"account"</span><span class="p">,</span> <span class="s2">"sim_id"</span><span class="p">,</span> <span class="s2">"block_type"</span><span class="p">,</span> <span class="s2">"advanced_seen"</span><span class="p">,</span> <span class="s2">"b2c_ttl"</span><span class="p">,</span>
               <span class="s2">"b2c_numbers"</span><span class="p">,</span> <span class="s2">"fake_cell_type"</span><span class="p">,</span> <span class="s2">"url_risky_type"</span><span class="p">,</span> <span class="s2">"creator"</span><span class="p">,</span>
               <span class="s2">"favorite_date"</span><span class="p">,</span> <span class="s2">"mx_id_v2"</span><span class="p">,</span> <span class="s2">"sub_id"</span><span class="p">]</span>
</code></pre></div><p data-pid="80GlB0WT">要解析这个格式的文本并不容易，首先，body 的内容可能是跨了多行的，不能默认每行是一条短信；其次，body 中也包含等号和逗号分隔符，字段并不能按照分隔符直接切分；最后，body 中包含<code>\x00</code>乱码。</p><p data-pid="AkEmINaf">当然，完全可以写一个循环，并使用正则表达式逐一匹配，但这样代码逻辑不够清晰，我最后考虑再三，打算采用 pyparsing 库配合正则表达式的 re 库建立一个文法解释器。pyparsing 库在我此前的文章中有提到：<a href="https://zhuanlan.zhihu.com/p/411043937" class="internal" target="_blank">清川：Pyparsing快速构建解释器 | 实战搜索查询语法</a>。</p><p data-pid="LSWjILEr">文法的定义很简单</p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">from</span> <span class="nn">pyparsing</span> <span class="kn">import</span> <span class="n">Suppress</span><span class="p">,</span> <span class="n">Word</span><span class="p">,</span> <span class="n">Regex</span><span class="p">,</span> <span class="n">ZeroOrMore</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">alphas</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># Define the grammar of the SMS data</span>
<span class="n">item_parser</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">alphas</span> <span class="o">+</span> <span class="s1">'_'</span><span class="p">)</span> <span class="o">+</span> <span class="n">Suppress</span><span class="p">(</span><span class="s1">'='</span><span class="p">)</span> <span class="o">+</span> <span class="n">Regex</span><span class="p">(</span><span class="sa">r</span><span class="s1">'.*?(?=(?:,\s*\w+=)|$)'</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="n">line_parser</span> <span class="o">=</span> <span class="n">Suppress</span><span class="p">(</span><span class="s1">'Row:'</span> <span class="o">+</span> <span class="n">Word</span><span class="p">(</span><span class="n">nums</span><span class="p">))</span> <span class="o">+</span> <span class="n">item_parser</span> <span class="o">+</span> <span class="n">ZeroOrMore</span><span class="p">(</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span> <span class="o">+</span> <span class="n">item_parser</span><span class="p">)</span>
</code></pre></div><p data-pid="GdmDbsiO">其中 alphas 就是所有的大小写字母组成的字符串，nums 是数字组成的字符串。Word(s) 表示一个仅由 s 内的字符组合构成的单词，Regex(s) 表示一个满足正则表达式 s 的单词，ZeroOrMore(s) 就是字面意思，表示存在零个或多个 s。除了 Suppress 只解析不收集返回值以外，Word 和 Regex 都会捕获匹配到的字符串。</p><p data-pid="YMlax-nY">这里稍微解释一下这个正则表达式。整个正则表达式<code>r'.*?(?=(?:,\s*\w+=)|$)'</code>的含义是：从当前位置开始匹配尽可能少的任意字符（<code>.*?</code>），直到遇到下一个键值对的开始（即逗号后跟键名和等号）或字符串的结尾。<code>(?= ... )</code>是一个正向前瞻断言，用于匹配某个模式前面的文本，但是不会捕获该模式的文本，即它仅用于验证接下来的部分是否存在。 <code>(?: ...)</code>是一个非捕获组，意味着我们定义了一个子模式，但不会把它匹配到的字符串返回。<code>re.DOTALL</code>参数标志允许点 <code>.</code> 匹配换行符，确保正确捕获多行值。</p><p data-pid="qgWXjHDo">如果此时我们使用 line_parser.parseString(line) 去解析一行文本，假设 line 包含多个 item，就会迭代地调用 item_parser.parseString(item)。由于 item_parser 会捕获关键字和值，所以会返回键值对的二元组，那么 line_parser 的返回值就是一个由二元组组成的列表。</p><p data-pid="CPzHBfZV">我们为这些解释器注册对应的后处理函数，在它们解析出字符串结果之后，对结果进行进一步处理。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="k">def</span> <span class="nf">make_hyperlink</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  <span class="c1"># Excel requires hyperlinks to be surrounded by spaces</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'\s*(https?://\S+)\s*'</span><span class="p">,</span> <span class="sa">r</span><span class="s1">' \1 '</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">item_parse_action</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">item</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"_id"</span><span class="p">,</span> <span class="s2">"sim_id"</span><span class="p">]:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">"date"</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> \
                        <span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">"body"</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">make_hyperlink</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">line_parse_action</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">as_list</span><span class="p">())</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">'【([^】]+)】'</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">'body'</span><span class="p">])</span>
    <span class="n">line</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">subject</span> <span class="k">else</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
    <span class="k">return</span> <span class="n">line</span>

<span class="n">item_parser</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">item_parse_action</span><span class="p">)</span>
<span class="n">line_parser</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">line_parse_action</span><span class="p">)</span>
</code></pre></div><p data-pid="0nKdAPcb">这里的 make_hyperlink 函数确保 body 中的链接前后刚好有一个空格，这是为后续将数据转换为 Excel 表做铺垫，链接和文字粘连时 Excel 打开会报错。item_parse_action 处理解析得到的键值对，将 _id 和 sim_id 转为整型数，将日期从时间戳解析成日期字符串，去除 body 中的乱码。line_parse_action 处理解析到的每条短信的字段列表。显示使用键值二元组列表构建字典，然后将 body 中用“【】”括起来的内容提取出来，作为短信的主题。当然有些短信是不包含主题的，我们就使用 uuid 库设置一个 unique 的值，避免在后续去重时误删数据。</p><p data-pid="W8N2yKXf">我们将原始短信整体读入，使用正则表达式切分出每条短信，然后使用文法解释器解析，得到一个列表，每个元素是一个字典，代表一条短信的各个字段。将其转换为 pandas 的 DataFrame。这里我发现我两个手机居然有 15741 条短信！</p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Parse the SMS data and transform it into a pandas DataFrame</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"sms.data"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">ifstream</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">"(Row:\s*\d+.*?)(?=Row:|$)"</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
    <span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">ifstream</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">data_frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">line_parser</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">lines</span><span class="p">)])</span>
</code></pre></div><p data-pid="3AyzHtGu">我们选取一些重要的字段，如 _id 是主键，address 是发信人号码，date 是收信时间，subject 是我们刚刚提取的主体，body 是短信内容，sim_id 是双卡中卡槽的编号。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># Select subset of fields</span>
<span class="n">selected_field_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"_id"</span><span class="p">,</span> <span class="s2">"address"</span><span class="p">,</span> <span class="s2">"date"</span><span class="p">,</span> <span class="s2">"subject"</span><span class="p">,</span> <span class="s2">"body"</span><span class="p">,</span> <span class="s2">"sim_id"</span><span class="p">,]</span>
<span class="n">data_frame</span> <span class="o">=</span> <span class="n">data_frame</span><span class="p">[</span><span class="n">selected_field_names</span><span class="p">]</span>
</code></pre></div><p data-pid="k_w53HnX">接下来按照号码和主题对短信进行去重，因为我们的目的是找到网站和应用的集合</p><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># remove duplicated addresses</span>
<span class="n">data_frame</span> <span class="o">=</span> <span class="n">data_frame</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">'address'</span><span class="p">,])</span>
<span class="n">data_frame</span> <span class="o">=</span> <span class="n">data_frame</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">,])</span>
</code></pre></div><p data-pid="sRKFGDtW">我们可以选择性地过滤掉肯定不包含账号的短信，例如 10086 开头的发信号码</p><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># filter out the rows with body containing specific keywords</span>
<span class="n">data_frame</span> <span class="o">=</span> <span class="n">data_frame</span><span class="p">[</span><span class="o">~</span><span class="n">data_frame</span><span class="p">[</span><span class="s1">'address'</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'10086'</span><span class="p">)]</span>
<span class="c1"># drop_keywords = ['spam', 'promotion', 'sale', 'discount']</span>
<span class="c1"># data_frame = data_frame[~data_frame['body'].str.contains('|'.join(drop_keywords), case=False)]</span>
</code></pre></div><p data-pid="rwfRTTi6">最后我们按照 SIM 卡的编号将过滤后的信息存储成 Excel 表</p><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># Save the data to an Excel file</span>
<span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s1">'sms.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'openpyxl'</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">data_frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_frame</span><span class="p">[</span><span class="s1">'sim_id'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">'sim_1'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data_frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_frame</span><span class="p">[</span><span class="s1">'sim_id'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">'sim_2'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div><figure data-size="normal"><noscript><img src="https://picx.zhimg.com/v2-5c4f8219ea636040726ca29c5fae53d8_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="2056" data-rawheight="372" class="origin_image zh-lightbox-thumb" width="2056" data-original="https://pic1.zhimg.com/v2-5c4f8219ea636040726ca29c5fae53d8_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='2056'%20height='372'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="2056" data-rawheight="372" class="origin_image zh-lightbox-thumb lazy" width="2056" data-original="https://pic1.zhimg.com/v2-5c4f8219ea636040726ca29c5fae53d8_720w.jpg?source=d16d100b" data-actualsrc="https://picx.zhimg.com/v2-5c4f8219ea636040726ca29c5fae53d8_720w.jpg?source=d16d100b"></figure><p data-pid="b-7CJFS0">过滤下来发现只剩下87条短信了，绝大多数的主题都是完整的，没有主题的也一般是好友来信而不是账号信息。把觉得重要的人工标记出来即可。这里我也尝试过对短信内容使用 NER（命名实体识别）的方式，但效果不佳，不如直接提取“【】”中内容。</p><h3>从应用列表中分析账号</h3><div class="highlight"><pre><code class="language-python"><span></span><span class="k">class</span> <span class="nc">AndroidDebugBridge</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adb_exe</span><span class="p">,</span> <span class="n">aapt_arm_pie</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb_exe</span> <span class="o">=</span> <span class="n">adb_exe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aapt_arm_pie</span> <span class="o">=</span> <span class="n">aapt_arm_pie</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">get_app_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"push </span><span class="si">{self.aapt_arm_pie}</span><span class="s2"> /data/local/tmp"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"shell chmod 0755 /data/local/tmp/aapt-arm-pie"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"shell pm list packages -3"</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">package</span> <span class="o">=</span> <span class="n">package</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">"package:"</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"shell pm path </span><span class="si">{package}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="s2">"package:"</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"shell /data/local/tmp/aapt-arm-pie d badging </span><span class="si">{path}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">app_name_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"application-label-zh-CN"</span><span class="p">,</span> <span class="s2">"application-label-zh"</span><span class="p">,</span> <span class="s2">"application-label"</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">app_name_field</span> <span class="ow">in</span> <span class="n">app_name_fields</span><span class="p">:</span>
                <span class="n">app_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rf</span><span class="s2">"</span><span class="si">{app_name_field}</span><span class="s2">:\s*'([^']+)'"</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">app_name</span><span class="p">:</span>
                    <span class="n">app_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app_name</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">app_names</span>
</code></pre></div><p data-pid="JLV352MC">这个就相对容易了，我们通过 aapt-arm-pie 这个手机端工具解析安装包以得到 APP 的名称。首先在 <a href="http://link.zhihu.com/?target=https%3A//github.com/Calsign/APDE/blob/fdc22eb31048862e1484f4b6eca229accda61466/APDE/src/main/assets/aapt-binaries/aapt-arm-pie" class=" wrap external" target="_blank" rel="nofollow noreferrer">这里</a> 下载该工具，然后将其绝对路径保存在 self.aapt_arm_pie 中。使用 push 命令将其保存在手机的 /data/local/tmp 目录下，然后修改其读写权限为 755，即 rwx、r-x、r-x 权限。</p><p data-pid="FLpzE96w">然后通过 pm list packages 得到包的列表，再通过 pm path 分别得到每个包的路径。每个包可能有多个路径，我们取其中第一个即可。然后使用 aapt-arm-pie 解析该路径中的包，会得到很复杂的信息。其中以 application-label 开头的行会包含 APP 的名称。</p><p data-pid="AOsRdsvO">最后我们对不同手机上的应用列表进行去重和排序：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="k">for</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">app_names_mi14</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">app_names_mi10pro</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
</code></pre></div><h3>从 Google 密码管理工具中分析账号</h3><p data-pid="W_5MWQPX">在 Chrome 中打开 <code>chrome://password-manager/passwords</code>，在搜索框内输入自己的手机号，就可以过滤出所有保存过的，以这个手机号注册的网站。如果平常使用别的浏览器，也有保存密码的习惯，当然也可以用类似的方法找到。Mac 我记得“钥匙串访问”中也会存储一部分账号密码。</p><h2>实验结果</h2><p data-pid="HuJCKYAj">根据以上步骤，我<b>共找到两个号码注册过的 145 个网站和应用</b>，相比于检查 10000+ 的短信，还是省了不少时间。当然啦，现在的手机一般比较智能，系统可能自带分类功能。比如小米系统就会把验证码单独分到一类里，你如果信得过它的分类算法也可以直接在那里面找。我和朋友测试的结果是，只要短信中包含“验证码”三个字，并且包含一段数字，就会被小米分类为验证码短信。</p><h2>完整代码</h2><p data-pid="84y6IEaD">从短信中分析账号</p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">from</span> <span class="nn">pyparsing</span> <span class="kn">import</span> <span class="n">Suppress</span><span class="p">,</span> <span class="n">Word</span><span class="p">,</span> <span class="n">Regex</span><span class="p">,</span> <span class="n">ZeroOrMore</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">alphas</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="c1"># adb shell content query --uri content://sms &gt; sms.data</span>

<span class="c1"># Define the grammar of the SMS data</span>
<span class="n">item_parser</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">alphas</span> <span class="o">+</span> <span class="s1">'_'</span><span class="p">)</span> <span class="o">+</span> <span class="n">Suppress</span><span class="p">(</span><span class="s1">'='</span><span class="p">)</span> <span class="o">+</span> <span class="n">Regex</span><span class="p">(</span><span class="sa">r</span><span class="s1">'.*?(?=(?:,\s*\w+=)|$)'</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="n">line_parser</span> <span class="o">=</span> <span class="n">Suppress</span><span class="p">(</span><span class="s1">'Row:'</span> <span class="o">+</span> <span class="n">Word</span><span class="p">(</span><span class="n">nums</span><span class="p">))</span> <span class="o">+</span> <span class="n">item_parser</span> <span class="o">+</span> <span class="n">ZeroOrMore</span><span class="p">(</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span> <span class="o">+</span> <span class="n">item_parser</span><span class="p">)</span>

<span class="c1"># Register the parse action for each item</span>
<span class="k">def</span> <span class="nf">make_hyperlink</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  <span class="c1"># Excel requires hyperlinks to be surrounded by spaces</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'\s*(https?://\S+)\s*'</span><span class="p">,</span> <span class="sa">r</span><span class="s1">' \1 '</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">item_parse_action</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">item</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"_id"</span><span class="p">,</span> <span class="s2">"sim_id"</span><span class="p">]:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">"date"</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> \
                        <span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">"body"</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">make_hyperlink</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">line_parse_action</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">as_list</span><span class="p">())</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">'【([^】]+)】'</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">'body'</span><span class="p">])</span>
    <span class="n">line</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">subject</span> <span class="k">else</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
    <span class="k">return</span> <span class="n">line</span>

<span class="n">item_parser</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">item_parse_action</span><span class="p">)</span>
<span class="n">line_parser</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">line_parse_action</span><span class="p">)</span>

<span class="c1"># Parse the SMS data and transform it into a pandas DataFrame</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"sms.data"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">ifstream</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">"(Row:\s*\d+.*?)(?=Row:|$)"</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
    <span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">ifstream</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">data_frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">line_parser</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">lines</span><span class="p">)])</span>

<span class="c1"># Select subset of fields</span>
<span class="n">selected_field_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"_id"</span><span class="p">,</span> <span class="s2">"address"</span><span class="p">,</span> <span class="s2">"date"</span><span class="p">,</span> <span class="s2">"subject"</span><span class="p">,</span> <span class="s2">"body"</span><span class="p">,</span> <span class="s2">"sim_id"</span><span class="p">,]</span>
<span class="n">data_frame</span> <span class="o">=</span> <span class="n">data_frame</span><span class="p">[</span><span class="n">selected_field_names</span><span class="p">]</span>

<span class="c1"># remove duplicated addresses</span>
<span class="n">data_frame</span> <span class="o">=</span> <span class="n">data_frame</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">'address'</span><span class="p">,])</span>
<span class="n">data_frame</span> <span class="o">=</span> <span class="n">data_frame</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">,])</span>

<span class="c1"># filter out the rows with body containing specific keywords</span>
<span class="n">data_frame</span> <span class="o">=</span> <span class="n">data_frame</span><span class="p">[</span><span class="o">~</span><span class="n">data_frame</span><span class="p">[</span><span class="s1">'address'</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'10086'</span><span class="p">)]</span>
<span class="c1"># drop_keywords = ['spam', 'promotion', 'sale', 'discount']</span>
<span class="c1"># data_frame = data_frame[~data_frame['body'].str.contains('|'.join(drop_keywords), case=False)]</span>

<span class="c1"># Save the data to an Excel file</span>
<span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s1">'sms.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'openpyxl'</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">data_frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_frame</span><span class="p">[</span><span class="s1">'sim_id'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">'sim_1'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data_frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_frame</span><span class="p">[</span><span class="s1">'sim_id'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">'sim_2'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div><p data-pid="mAgGBTXW">从应用列表中分析账号</p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">import</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">re</span>


<span class="k">class</span> <span class="nc">AndroidDebugBridge</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adb_exe</span><span class="p">,</span> <span class="n">aapt_arm_pie</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb_exe</span> <span class="o">=</span> <span class="n">adb_exe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aapt_arm_pie</span> <span class="o">=</span> <span class="n">aapt_arm_pie</span>
    
    <span class="k">def</span> <span class="nf">connet_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"connect {':'.join(address)}"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pair_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">pairing_code</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"&gt;&gt;&gt; adb pair {':'.join(address)}"</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">adb_exe</span><span class="p">,</span> <span class="s2">"pair"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"{':'.join(address)}"</span><span class="p">,</span> <span class="n">pairing_code</span><span class="p">],</span> 
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">pairing_code</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">disconnect_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">"devices"</span><span class="p">)</span>
        <span class="n">device_id</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"-s </span><span class="si">{device_id}</span><span class="s2"> disconnect"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">adb_exe</span><span class="p">]</span> <span class="o">+</span> <span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"When running command `</span><span class="si">{command}</span><span class="s2">`,</span><span class="se">\n</span><span class="s2">An error occurred: </span><span class="si">{e}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"&gt;&gt;&gt; adb </span><span class="si">{command}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
    
    <span class="k">def</span> <span class="nf">get_sms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofstream</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">"shell content query --uri content://sms"</span><span class="p">)</span>
            <span class="n">ofstream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_app_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"push </span><span class="si">{self.aapt_arm_pie}</span><span class="s2"> /data/local/tmp"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"shell chmod 0755 /data/local/tmp/aapt-arm-pie"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"shell pm list packages -3"</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">package</span> <span class="o">=</span> <span class="n">package</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">"package:"</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"shell pm path </span><span class="si">{package}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="s2">"package:"</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"shell /data/local/tmp/aapt-arm-pie d badging </span><span class="si">{path}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">app_name_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"application-label-zh-CN"</span><span class="p">,</span> <span class="s2">"application-label-zh"</span><span class="p">,</span> <span class="s2">"application-label"</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">app_name_field</span> <span class="ow">in</span> <span class="n">app_name_fields</span><span class="p">:</span>
                <span class="n">app_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rf</span><span class="s2">"</span><span class="si">{app_name_field}</span><span class="s2">:\s*'([^']+)'"</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">app_name</span><span class="p">:</span>
                    <span class="n">app_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app_name</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">app_names</span>

<span class="n">adb</span> <span class="o">=</span> <span class="n">AndroidDebugBridge</span><span class="p">(</span>
    <span class="n">adb_exe</span><span class="o">=</span><span class="sa">r</span><span class="s2">"D:\softwares\adb\adb.exe"</span><span class="p">,</span> 
    <span class="n">aapt_arm_pie</span><span class="o">=</span><span class="sa">r</span><span class="s2">"C:\Users\qingchuan\Downloads\aapt-arm-pie"</span><span class="p">)</span>
<span class="n">adb</span><span class="o">.</span><span class="n">connet_device</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="s2">"192.168.72.11"</span><span class="p">,</span> <span class="s2">"43185"</span><span class="p">))</span>
<span class="n">app_names_mi10pro</span> <span class="o">=</span> <span class="n">adb</span><span class="o">.</span><span class="n">get_app_names</span><span class="p">()</span>
<span class="n">adb</span><span class="o">.</span><span class="n">connet_device</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="s2">"192.168.142.211"</span><span class="p">,</span> <span class="s2">"34565"</span><span class="p">))</span>
<span class="n">app_names_mi14</span> <span class="o">=</span> <span class="n">adb</span><span class="o">.</span><span class="n">get_app_names</span><span class="p">()</span>
<span class="k">for</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">app_names_mi14</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">app_names_mi10pro</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
</code></pre></div><p data-pid="fs7UrNvY">以上代码是我自己写的，没有版权，也不对其负责。关于 adb 的更多的用法可以参考 <a href="http://link.zhihu.com/?target=https%3A//github.com/sweetorange2022/Best-Adb-Tutorials" class=" wrap external" target="_blank" rel="nofollow noreferrer">Best-Adb-Tutorials</a>。</p>