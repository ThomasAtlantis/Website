<p data-pid="TbeAHR53">今天也遇到并解决了这个问题，事后才发现已有很多讨论，<b>但背后的原理还有待细说</b>。遇到这个问题的时候最先想到的就是抓包分析一下，因为知乎既然支持实时的自动补全，一定有网络请求。</p><p data-pid="Hmy-yhYW">我们在知乎编辑器页面打开浏览器的开发者工具-网络菜单，清空一下当前流量，然后在编辑器里输入 <a class="member_mention" href="https://www.zhihu.com/people/fe459e428af0b5f8abb53f2f4f3c732c" data-hash="fe459e428af0b5f8abb53f2f4f3c732c" data-hovercard="p$b$fe459e428af0b5f8abb53f2f4f3c732c">@清川</a>，就可以发现网页发送了以下请求数据：</p><figure data-size="normal"><noscript><img src="https://picx.zhimg.com/50/v2-6840480597e467a75722b11a6f82ef98_720w.jpg?source=c8b7c179" data-caption="" data-size="normal" data-original-token="v2-6840480597e467a75722b11a6f82ef98" class="content_image"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='0'%20height='0'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-original-token="v2-6840480597e467a75722b11a6f82ef98" class="content_image lazy" data-actualsrc="https://picx.zhimg.com/50/v2-6840480597e467a75722b11a6f82ef98_720w.jpg?source=c8b7c179"></figure><p data-pid="BtJp_HeF">我们可以看到知乎使用的自动补全接口如下，其中%E6%B8%85%E5%B7%9D是「清川 」的URL编码。</p><div class="highlight"><pre><code class="language-text"><span></span>https://www.zhihu.com/people/autocomplete?token=%E6%B8%85%E5%B7%9D&amp;max_matches=10&amp;use_similar=0
</code></pre></div><p data-pid="MeJTm4my"><b>可以看到后面的max_matches字段赫然写着10，这意味着每次查询只返回10条结果。</b>而这个请求是写死在知乎编辑器的JS逻辑里的，也就是说，就算前端UI不控制只显示6条，你也是看不到其他人的。这里知乎其实是为了做通信量的优化，但少了一个功能性逻辑，就是在@后面自动补全的列表滚到底端时再发送一条新的请求，请求10条以后的结果。但是这样呢，后台就要对每次请求维护一个分页表，又增加了性能成本，于是索性不管了。</p><p data-pid="Fz7pkcY-">由于上面的数据包是一个GET请求，我们把链接直接放到浏览器地址栏，并把最大匹配数量改到100000试试。一般来说不会有这么多重名，就可以看到所有结果了。然而这时看到的却是：</p><div class="highlight"><pre><code class="language-text"><span></span>[["entry"]]
</code></pre></div><p data-pid="C1Fv3MoU">说明后台设置了上限值，不能这么大。我们二分查找一点点尝试，最后试出来最大数量是500。也就是说这里也有潜在的BUG，当重名数量达到500时，还是会有用户被检索不到。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/50/v2-7cf1dd9c49b34277955d301536f96c94_720w.jpg?source=c8b7c179" data-caption="" data-size="normal" data-rawwidth="1244" data-rawheight="338" data-original-token="v2-41aff7df81bd58aa905cd8bf71f4fb62" data-default-watermark-src="https://picx.zhimg.com/50/v2-49ceb7826b7b1f569d9cac11230a0ad7_720w.jpg?source=c8b7c179" class="origin_image zh-lightbox-thumb" width="1244" data-original="https://picx.zhimg.com/v2-7cf1dd9c49b34277955d301536f96c94_r.jpg?source=c8b7c179"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1244'%20height='338'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1244" data-rawheight="338" data-original-token="v2-41aff7df81bd58aa905cd8bf71f4fb62" data-default-watermark-src="https://picx.zhimg.com/50/v2-49ceb7826b7b1f569d9cac11230a0ad7_720w.jpg?source=c8b7c179" class="origin_image zh-lightbox-thumb lazy" width="1244" data-original="https://picx.zhimg.com/v2-7cf1dd9c49b34277955d301536f96c94_r.jpg?source=c8b7c179" data-actualsrc="https://pic1.zhimg.com/50/v2-7cf1dd9c49b34277955d301536f96c94_720w.jpg?source=c8b7c179"></figure><p data-pid="GEtjZPuM">我们把结果丢进<a href="https://link.zhihu.com/?target=https%3A//www.bejson.com/explore/index_new/" class=" wrap external" target="_blank" rel="nofollow noreferrer">JSON在线格式化网站</a>中整理一下：</p><figure data-size="normal"><noscript><img src="https://picx.zhimg.com/50/v2-0e875cd568962b30a2b4dd045b421a3e_720w.jpg?source=c8b7c179" data-caption="" data-size="normal" data-rawwidth="1635" data-rawheight="661" data-original-token="v2-cb177c414db70ed40f615326ef95caae" data-default-watermark-src="https://pica.zhimg.com/50/v2-3eb494258163753146e0712deb818e27_720w.jpg?source=c8b7c179" class="origin_image zh-lightbox-thumb" width="1635" data-original="https://picx.zhimg.com/v2-0e875cd568962b30a2b4dd045b421a3e_r.jpg?source=c8b7c179"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1635'%20height='661'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1635" data-rawheight="661" data-original-token="v2-cb177c414db70ed40f615326ef95caae" data-default-watermark-src="https://pica.zhimg.com/50/v2-3eb494258163753146e0712deb818e27_720w.jpg?source=c8b7c179" class="origin_image zh-lightbox-thumb lazy" width="1635" data-original="https://picx.zhimg.com/v2-0e875cd568962b30a2b4dd045b421a3e_r.jpg?source=c8b7c179" data-actualsrc="https://picx.zhimg.com/50/v2-0e875cd568962b30a2b4dd045b421a3e_720w.jpg?source=c8b7c179"></figure><p data-pid="txd1FnXI">可以清楚地发现每个用户的信息列表里第2个位置处都有一个唯一的字符串，这个其实是用户的标识，暂且称其为用户字符串，可以在用户主页的网址中找到。</p><figure data-size="normal"><noscript><img src="https://picx.zhimg.com/50/v2-9420e9a812c50d486740f2fa6d3c996f_720w.jpg?source=c8b7c179" data-caption="" data-size="normal" data-rawwidth="1041" data-rawheight="512" data-original-token="v2-1ee19c630c1ba9c3d14510fa67f24219" data-default-watermark-src="https://picx.zhimg.com/50/v2-ba5bd3fbedddff84bccfdd12ae9dca97_720w.jpg?source=c8b7c179" class="origin_image zh-lightbox-thumb" width="1041" data-original="https://picx.zhimg.com/v2-9420e9a812c50d486740f2fa6d3c996f_r.jpg?source=c8b7c179"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1041'%20height='512'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1041" data-rawheight="512" data-original-token="v2-1ee19c630c1ba9c3d14510fa67f24219" data-default-watermark-src="https://picx.zhimg.com/50/v2-ba5bd3fbedddff84bccfdd12ae9dca97_720w.jpg?source=c8b7c179" class="origin_image zh-lightbox-thumb lazy" width="1041" data-original="https://picx.zhimg.com/v2-9420e9a812c50d486740f2fa6d3c996f_r.jpg?source=c8b7c179" data-actualsrc="https://picx.zhimg.com/50/v2-9420e9a812c50d486740f2fa6d3c996f_720w.jpg?source=c8b7c179"></figure><p data-pid="Z9z679-K">并不是用户的唯一标识就一定能用于搜索，很多答主的逻辑不对，爬过知乎的会很清楚知乎用户是有id的，但不是这个字符串，比如我的「fe459e428af0b5f8abb53f2f4f3c732c」。</p><p data-pid="qNu_V662">这里取决于后台实现逻辑，可以从返回值字段入手进行猜测。后来实验结果验证了其实@后面可以搜索的内容很多：</p><table data-draft-node="block" data-draft-type="table" data-size="normal" data-row-style="normal"><tbody><tr><th>可搜索字段名</th><th>字段值举例</th></tr><tr><td>用户名</td><td>清川</td></tr><tr><td>用户字符串</td><td>liu-ji-27-94</td></tr><tr><td>一句话介绍</td><td>科研小学生，关注模型压缩与联邦学习</td></tr><tr><td>个人简介</td><td>一部关于人生的游记：人间纪行(<a href="https://link.zhihu.com/?target=https%3A//liushangyu.xyz" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">liushangyu.xyz</span><span class="invisible"></span></a>)</td></tr></tbody></table><p data-pid="GpRpuP7P">你甚至在搜索的时候同时输入多个字段值，将不同的字段值用空格隔开。这就让人可以猜想出后台的搜索逻辑：将可搜索字段信息连接成字符串，对每个查询字段值取最大匹配的交集。而搜索结果的顺序嘛，就是知乎首页搜索栏搜索出来的顺序，按照最近的创作活跃度排序，这里也很有可能是复用了搜索接口。</p><p data-pid="ZjEoqKec"><b>结论：当用户不在提示列表里，或者重名且头像相同（默认头像）时，我们就可以使用用户字符串去搜索ta。用户字符串可以在个人主页地址获取。</b></p>